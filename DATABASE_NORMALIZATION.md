# Database Normalization Recommendations

You mentioned your database is getting "messy". Normalization is the process of organizing data to reduce redundancy and improve integrity.

Since you want to improve it **without destroying existing functionality**, I recommend a phased approach. You can create new tables and migrate data gradually, or just use these for future features.

## 1. The Group Chat (Priority)
Currently, we are stuffing chat messages into the `notes` table as JSON. This is "messy" because it duplicates user data (name/avatar) in every message and makes queries harder.

**Recommendation:** Create a dedicated table.

```sql
-- Create a new table for group chat
create table public.group_messages (
  id bigint generated by default as identity primary key,
  sender_id uuid references public.students(id) not null,
  content text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Enable Row Level Security (RLS)
alter table public.group_messages enable row level security;

-- Policy: Everyone can read
create policy "Enable read access for all users" on public.group_messages for select using (true);

-- Policy: Authenticated users can insert
create policy "Enable insert for authenticated users" on public.group_messages for insert with check (auth.role() = 'authenticated');
```

**Migration Strategy:**
1. Create this table in Supabase.
2. Update `js/group-chat.js` to insert into `group_messages` instead of `notes`.
3. Update `js/group-chat.js` to select from `group_messages`.
4. (Optional) Write a script to move old "CHAT_HIDDEN" notes to this new table.

## 2. Subjects & Schedule (Medium Priority)
Currently, `schedule`, `assignments`, and `shared_files` all type out the Subject Name (e.g., "IT 211"). If you change a subject name, you have to change it in 3 tables and multiple rows.

**Recommendation:** Create a central `subjects` table.

```sql
create table public.subjects (
  id bigint generated by default as identity primary key,
  code text unique not null, -- e.g. "IT 211"
  name text not null,        -- e.g. "Integrative Programming"
  instructor text,           -- e.g. "Sir Greg"
  meet_link text,
  classroom_link text
);
```

**Refactored Schedule Table:**
Instead of storing all that info, you just store the `subject_id`.

```sql
-- The new schedule table would look like this:
create table public.schedule_normalized (
  id bigint generated by default as identity primary key,
  subject_id bigint references public.subjects(id),
  day_of_week text,
  start_time time,
  end_time time,
  room text
);
```

**Why this helps:**
- If "Sir Greg" changes his Meet Link, you update it **once** in `subjects`, and it automatically updates for all Schedule blocks, Assignments, and Files linked to that subject.

## 3. Student Metadata (Low Priority)
Your `students` table is quite heavy (`role`, `enrollment_status`, `avatar_url`, `password`).

**Recommendation:**
- Keep `students` for core auth/profile.
- If you add more game-like features (XP, Level, Badges), move them to a `student_stats` table to keep the main table clean.

## Immediate Action Items (Safe to do now)
1. **Run the SQL for `group_messages`**. It won't break anything because your current code uses `notes`. You can switch the code over whenever you are ready.
2. **Back up your data** (Supabase -> Database -> Backups) before making big changes.

Let me know if you want me to write the code to switch the Chat System to the new `group_messages` table!
