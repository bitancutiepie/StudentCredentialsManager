<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ni JV</title>
    <!-- Supabase -->
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/images/logo.png">
    <link rel="apple-touch-icon" href="assets/images/logo.png">
    <!-- Open Graph / Social Media Sharing Image -->
    <meta property="og:image" content="assets/images/logo.png">
    <meta name="twitter:image" content="assets/images/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        (function () {
            emailjs.init("KtQgxJvMwR6IfuU3_");
        })();
    </script>
    <!-- html2canvas for Wallpaper Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- PDF.js for Schedule Scanning -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Permanent+Marker&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">



    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* Group Chat Styles */
        .gc-message {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            max-width: 85%;
        }

        .gc-message.me {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .gc-message.them {
            align-self: flex-start;
        }

        .gc-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #000;
            flex-shrink: 0;
            object-fit: cover;
        }

        .gc-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 100%;
        }

        .gc-message.me .gc-content-wrapper {
            align-items: flex-end;
        }

        .gc-name {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 2px;
            font-weight: bold;
        }

        .gc-bubble {
            padding: 8px 12px;
            border-radius: 15px;
            border: 2px solid #000;
            font-size: 0.95rem;
            word-wrap: break-word;
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.1);
        }

        .gc-message.me .gc-bubble {
            background: #6c5ce7;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .gc-message.them .gc-bubble {
            background: #fff;
            color: black;
            border-bottom-left-radius: 2px;
        }

        .gc-time {
            font-size: 0.65rem;
            color: #999;
            margin-top: 2px;
        }

        #groupChatModal {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 350px;
            height: 500px;
            z-index: 9000;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease-out;
            filter: drop-shadow(5px 5px 0 #000);
        }

        @media (max-width: 600px) {
            #groupChatModal {
                width: 90%;
                right: 5%;
                bottom: 20px;
                height: 60vh;
            }
        }

        /* Announcement Mini Card Styles */
        .ann-mini-card {
            background: #fdfdfd;
            border: 2px solid #000;
            padding: 10px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            font-size: 1rem;
            box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.05);
            text-align: left;
        }

        .ann-mini-card:hover {
            transform: scale(1.05) rotate(-1.5deg);
            background: #fff;
            box-shadow: 4px 4px 0 #000;
            z-index: 5;
        }

        .ann-mini-card small {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #d63031;
            font-size: 0.75rem;
            margin-top: 8px;
            font-weight: bold;
            opacity: 0.8;
        }

        /* Peek Preview Styles */
        .ann-peek {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
            display: none;
            animation: peekFadeIn 0.3s ease-out;
            pointer-events: none;
        }

        .ann-mini-card:hover .ann-peek {
            display: block;
        }

        .peek-title {
            font-family: 'Permanent Marker', cursive;
            font-size: 0.8rem;
            margin-bottom: 5px;
            color: #6c5ce7;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .peek-line {
            font-size: 0.8rem;
            line-height: 1.4;
            margin-bottom: 4px;
            font-family: 'Patrick Hand', cursive;
            background: rgba(108, 92, 231, 0.05);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 2px solid #6c5ce7;
        }

        @keyframes peekFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 800px) {
            .ann-mini-card:hover .ann-peek {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <!-- HAMILAW OVERLAY (JUMPSCARE) -->
    <div id="hamilaw-overlay" class="hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200000; display: flex; justify-content: center; align-items: center; pointer-events: none;">
        <img src="monster.png" id="hamilaw-img" style="width: 100%; height: 100%; object-fit: contain;">
    </div>


    <div class="binder">
        <!-- The Spine / Sidebar -->
        <div class="sidebar">
            <div class="binder-ring"></div>
            <div class="binder-ring"></div>
            <div class="binder-ring"></div>

            <!-- Active users removed from here to move to header -->
        </div>

        <!-- The Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('schedule', event)">Schedule</button>
            <button class="tab-btn" onclick="switchTab('assignments', event)" style="background: #fab1a0;">To Do
                List</button>
            <button class="tab-btn" onclick="switchTab('calendar', event)">Events</button>
            <button class="tab-btn" onclick="switchTab('links', event)">Files</button>
            <button class="tab-btn" onclick="switchTab('help', event)">Help Guide</button>
            <button class="tab-btn admin-only hidden" onclick="switchTab('admin-tools', event)"
                style="background: #2d3436; color: #fff; transform: rotate(-2deg);">Admin Tools</button>
        </div>

        <!-- The Main Paper Content -->
        <div class="paper-content">

            <div
                style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
                <div class="sticky-time" style="margin: 0;">
                    <span class="pin"><i class="fas fa-thumbtack"></i></span>
                    <small>TIME CHECK:</small>
                    <div id="live-clock">00:00</div>
                </div>

                <!-- RECENT ANNOUNCEMENTS PANEL (BULLETIN) -->
                <div id="recent-announcements-panel" style="font-family: 'Patrick Hand';">
                    <div class="sketch-box"
                        style="padding: 20px 15px; margin: 0; width: 250px; min-height: 140px; transform: rotate(-1.5deg); box-shadow: 6px 6px 0 #000; background: #fff; border-width: 3px; position: relative; display: flex; flex-direction: column; justify-content: center;">
                        <h3
                            style="margin: 0 0 10px 0; text-align: center; text-decoration: underline wavy; font-size: 1.4rem; color: #000; line-height: 1;">
                            <i class="fas fa-bullhorn" style="color: #d63031;"></i> Bulletin
                        </h3>
                        <div id="announcements-list"
                            style="max-height: 90px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 5px 8px;"
                            class="custom-scroll">
                            <p style="text-align: center; color: #666; font-style: italic; font-size: 0.9rem;">Reading
                                notes...</p>
                        </div>

                        <!-- Tape Graphic (Top) -->
                        <div
                            style="position: absolute; top: -12px; left: 35%; width: 50px; height: 22px; background: rgba(0,0,0,0.08); border-left: 1px dashed rgba(255,255,255,0.4); border-right: 1px dashed rgba(255,255,255,0.4); transform: rotate(-3deg); z-index: 2;">
                        </div>

                        <!-- NEW: Quick Add Announcement (Bottom Left) -->
                        <button class="admin-only hidden" onclick="window.quickAddAnnouncement()"
                            style="position: absolute; bottom: 8px; left: 10px; width: 30px; height: 30px; background: #e74c3c; color: #fff; border: 2px solid #000; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 2px 2px 0 rgba(0,0,0,0.2); transition: all 0.2s ease; z-index: 10;"
                            title="Quick Add Announcement"
                            onmouseover="this.style.transform='scale(1.2) rotate(10deg)'; this.style.background='#c0392b';"
                            onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.background='#e74c3c';">
                            <i class="fas fa-plus"></i>
                        </button>

                        <!-- Pin Graphic (Bottom corner) -->
                        <div style="position: absolute; bottom: 5px; right: 5px; opacity: 0.2; font-size: 0.8rem;"><i
                                class="fas fa-thumbtack"></i></div>
                    </div>
                </div>
            </div>

            <!-- REORGANIZED HEADER INFO -->


            <div class="profile-header-container">
                <!-- Avatar & Inbox Group -->
                <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div style="position: relative;">
                            <img id="userAvatarDisplay"
                                style="width: 65px; height: 65px; border-radius: 50%; border: 2px solid #000; cursor: pointer; object-fit: cover;"
                                title="Click to change profile picture">
                            <div onclick="document.getElementById('userAvatarDisplay').click()"
                                style="position: absolute; bottom: -2px; right: -5px; background: #2d3436; color: #fff; border: 2px solid #fff; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; box-shadow: 2px 2px 0 rgba(0,0,0,0.2); cursor: pointer;">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <!-- Group Chat Button -->
                        <div onclick="window.groupChat.toggle()"
                            style="position: relative; cursor: pointer; font-size: 2rem; color: #6c5ce7; margin-right: 5px;"
                            title="Class Group Chat">
                            <i class="fas fa-comments"></i>
                            <span id="gc-badge"
                                style="position: absolute; top: -5px; right: -5px; background: #d63031; color: #fff; font-size: 0.8rem; font-weight: bold; padding: 2px 6px; border-radius: 50%; display: none;">!</span>
                        </div>

                        <div onclick="openInboxModal()"
                            style="position: relative; cursor: pointer; font-size: 2rem; color: #2d3436;"
                            title="My Messages">
                            <i class="fas fa-envelope"></i>
                            <span id="msg-badge"
                                style="position: absolute; top: -5px; right: -5px; background: #d63031; color: #fff; font-size: 0.8rem; font-weight: bold; padding: 2px 6px; border-radius: 50%; display: none;">0</span>
                        </div>
                    </div>
                    <!-- NEW: Edit Name Button -->
                    <button onclick="editUserName()" class="sketch-btn"
                        style="padding: 2px 8px; font-size: 0.8rem; transform: rotate(-1deg); width: auto; margin-top: -5px;">
                        <i class="fas fa-user-edit"></i> Change Name
                    </button>
                </div>

                <!-- Text Info Stack -->
                <div class="profile-text-stack">
                    <div id="enrollment-badge"
                        style="display:none; font-size: 0.85rem; font-weight:bold; padding: 4px 10px; border-radius: 4px; white-space: nowrap;">
                    </div>
                    <p id="welcome-msg"
                        style="background: yellow; display: inline-block; transform: rotate(-1.5deg); padding: 2px 8px; margin: 0; font-size: 1.2rem; border: 1px solid rgba(0,0,0,0.1);">
                        Loading User...</p>
                    <div onclick="editUserStatus()" style="cursor: pointer; transform: rotate(1deg); padding-left: 5px;"
                        title="Edit status">
                        <small
                            style="font-family: 'Patrick Hand'; color: #2f3542; border-bottom: 1px dashed #a4b0be; font-size: 1.1rem;"><span
                                id="user-status-text">Certified Member</span> <i class="fas fa-pencil-alt"
                                style="font-size: 0.8rem; margin-left: 5px;"></i></small>
                    </div>
                </div>
            </div>

            <!-- NEW: Modern Online Users Stack -->
            <div id="active-users-panel" class="online-users-header">
                <p class="online-label">ONLINE CLASSMATES:</p>
                <div id="active-users-list" class="avatar-stack">
                    <!-- Avatars move here -->
                    <small style="color: #636e72;">Scanning...</small>
                </div>
            </div>

            <!-- DYNAMIC LIVE CLASS SECTION -->
            <div id="live-class-container" style="display: none; margin-bottom: 20px;">
                <!-- JavaScript will inject the card here -->
            </div>

            <!-- Logout Button (Hidden in plain sight as a doodle button) -->
            <div style="margin-top: 10px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="toggleWideMode()" class="sketch-btn" style="border: none; text-decoration: underline;"
                    title="Stretch View">
                    <i class="fas fa-expand-arrows-alt"></i> Wide View
                </button>
                <button onclick="window.location.href='index.html'" class="sketch-btn admin-only hidden"
                    style="border: none; text-decoration: underline; color: #636e72;">
                    <i class="fas fa-undo"></i> Admin Menu
                </button>
                <button onclick="logout()" class="sketch-btn danger" style="border: none; text-decoration: underline;">
                    <i class="fas fa-door-open"></i> Go Home
                </button>
            </div>

            <br>

            <!-- ================= ADMIN TOOLS TAB (NEW SECTION) ================= -->
            <div id="admin-tools" class="tab-content hidden">
                <h2><i class="fas fa-user-shield"></i> Admin Control Panel</h2>

                <!-- Admin Tool Navigation -->
                <div class="filter-bar" style="justify-content: center; gap: 10px; margin-bottom: 20px;">
                    <button class="sketch-btn" onclick="showAdminTool('admin-schedule-form', this)"><i
                            class="fas fa-clock"></i> Class</button>
                    <button class="sketch-btn" onclick="showAdminTool('admin-assignment-form', this)"><i
                            class="fas fa-thumbtack"></i> Homework</button>
                    <button class="sketch-btn" onclick="showAdminTool('admin-event-form', this)"><i
                            class="fas fa-calendar-alt"></i> Event</button>
                    <button class="sketch-btn" onclick="showAdminTool('admin-file-form', this)"><i
                            class="fas fa-paperclip"></i> File</button>
                    <button class="sketch-btn" onclick="showAdminTool('admin-todo-form', this)"><i
                            class="fas fa-check-double"></i> To-Do</button>
                    <button class="sketch-btn" onclick="showAdminTool('admin-email-form', this)"><i
                            class="fas fa-envelope"></i> Email</button>
                    <button class="sketch-btn" onclick="showAdminTool('admin-message-manager', this)"><i
                            class="fas fa-comments"></i> Messages</button>
                    <button class="sketch-btn" onclick="showAdminTool('admin-gallery-form', this)"><i
                            class="fas fa-images"></i> Gallery</button>
                    <button class="sketch-btn" onclick="showAdminTool('admin-storage-view', this)"><i
                            class="fas fa-hdd"></i> Storage</button>
                    <button class="sketch-btn" onclick="showAdminTool('admin-promote-form', this)"><i
                            class="fas fa-crown"></i> Privileges</button>
                    <button id="btn-broadcast-tool" class="sketch-btn hidden"
                        onclick="showAdminTool('admin-announcement-form', this)"
                        style="border-color: #6c5ce7; color: #6c5ce7;"><i class="fas fa-bullhorn"></i>
                        Announcement</button>
                    <button id="btn-force-update" class="sketch-btn hidden" onclick="broadcastSystemUpdate()"
                        style="border-color: #e67e22; color: #e67e22;"><i class="fas fa-sync-alt"></i> Force
                        Update</button>
                    <button id="btn-revoke-admin" class="sketch-btn hidden"
                        onclick="showAdminTool('admin-revoke-form', this)"
                        style="border-color: #d63031; color: #d63031;"><i class="fas fa-user-slash"></i> Revoke</button>
                </div>
                <p style="text-align: center; font-style: italic; color: #666; margin-bottom: 20px;"
                    id="admin-tool-hint">Select a tool above to get started.</p>

                <div class="grid-container" style="grid-template-columns: 1fr;">
                    <!-- Moved Forms -->
                    <div class="admin-controls" id="admin-schedule-form">
                        <button onclick="showAdminTool(null)" class="sketch-btn danger"
                            style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                        <h3>Admin's Note: Add Class</h3>
                        <form onsubmit="addClass(event)" autocomplete="off">
                            <select id="s-day" required>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                            </select>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="text" id="s-code" placeholder="Code (IT 211)" required>
                                <input type="text" id="s-name" placeholder="Subject Name" required>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="time" id="s-start" required>
                                <input type="time" id="s-end" required>
                            </div>
                            <input type="text" id="s-room" placeholder="Room / Lab">
                            <input type="text" id="s-instructor" placeholder="Instructor">
                            <input type="url" id="s-meet" placeholder="G-Meet Link">
                            <input type="url" id="s-class" placeholder="Classroom Link">
                            <button type="submit" class="sketch-btn" style="background: #000; color: #fff;">Save to
                                Schedule</button>
                        </form>
                    </div>

                    <div class="admin-controls" id="admin-assignment-form">
                        <button onclick="showAdminTool(null)" class="sketch-btn danger"
                            style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                        <h3>Admin's Note: Add Homework</h3>
                        <form onsubmit="addAssignment(event)" autocomplete="off">
                            <input type="text" id="a-title" placeholder="Title" required>
                            <input type="text" id="a-subject" placeholder="Subject (e.g. Math)" required>
                            <input type="datetime-local" id="a-due">
                            <textarea id="a-desc" placeholder="Details..."></textarea>
                            <button type="submit" class="sketch-btn" style="background: #000; color: #fff;">Post
                                Homework</button>
                        </form>
                    </div>

                    <div class="admin-controls" id="admin-event-form">
                        <button onclick="showAdminTool(null)" class="sketch-btn danger"
                            style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                        <h3>Admin's Note: Add Event</h3>
                        <form onsubmit="addEvent(event)" autocomplete="off">
                            <input type="text" id="e-title" placeholder="Event Name" required>
                            <input type="date" id="e-date" required>
                            <input type="text" id="e-desc" placeholder="Description">
                            <button type="submit" class="sketch-btn" style="background: #000; color: #fff;">Save
                                Event</button>
                        </form>
                    </div>

                    <div class="admin-controls" id="admin-file-form">
                        <button onclick="showAdminTool(null)" class="sketch-btn danger"
                            style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                        <h3>Admin's Note: Upload Resource</h3>
                        <form onsubmit="uploadFile(event)" autocomplete="off">
                            <input type="text" id="f-title" placeholder="File Title (e.g. Week 1 Reviewer)" required>

                            <!-- Subject Selection (Empty - JS will fill this) -->
                            <select id="f-subject" required style="margin-bottom: 10px;">
                                <option value="" disabled selected>Select Subject</option>
                                <option value="General">General / Other</option>
                                <!-- JavaScript will add your Schedule subjects here -->
                            </select>

                            <input type="file" id="f-file" required
                                accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.png,.jpeg">
                            <button type="submit" class="sketch-btn" id="upload-btn"
                                style="background: #000; color: #fff;">
                                <i class="fas fa-paperclip"></i> Upload to Cabinet
                            </button>
                        </form>
                    </div>

                    <div class="admin-controls" id="admin-todo-form">
                        <button onclick="showAdminTool(null)" class="sketch-btn danger"
                            style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                        <h3>Admin's Note: Global To-Do <i class="fas fa-check-double"></i></h3>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">(Post a task for everyone to complete)</p>
                        <form onsubmit="addGlobalTodo(event)" autocomplete="off">
                            <input type="text" id="todo-task" placeholder="Task description (e.g. Pass Receipt...)"
                                required>
                            <button type="submit" class="sketch-btn" style="background: #000; color: #fff;">
                                <i class="fas fa-plus"></i> Post Task
                            </button>
                        </form>
                    </div>

                    <div class="admin-controls" id="admin-email-form">
                        <button onclick="showAdminTool(null)" class="sketch-btn danger"
                            style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                        <h3>Admin's Note: Email Center <i class="fas fa-envelope"></i></h3>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">(Select a specific student or blast everyone)
                        </p>

                        <form onsubmit="sendEmailService(event)" autocomplete="off">
                            <!-- NEW: Recipient Dropdown -->
                            <select id="email-recipient"
                                style="width: 100%; padding: 10px; margin-bottom: 10px; border: none; border-bottom: 2px solid #333; font-family: 'Patrick Hand'; font-size: 1.2rem; background: transparent;">
                                <option value="ALL">Send to Everyone (Blast)</option>
                                <!-- JavaScript will load student names here -->
                            </select>

                            <input type="text" id="email-subject" placeholder="Subject (e.g. You passed!)" required>
                            <div style="position: relative; margin-bottom: 20px;">
                                <textarea id="email-body" placeholder="Write your message here..."
                                    style="height: 120px; width: 100%; box-sizing: border-box;"></textarea>
                                <button type="button" onclick="quickAddHomeworkToEmail()" class="sketch-btn"
                                    title="Auto-retrieve Homework List"
                                    style="position: absolute; bottom: 5px; right: 5px; width: auto; margin: 0; background: #f1c40f; color: #000; padding: 4px 10px; font-size: 0.8rem; z-index: 5;">
                                    <i class="fas fa-list-check"></i> IMPORT HOMEWORK
                                </button>
                            </div>

                            <button type="submit" class="sketch-btn"
                                style="background: #000; color: #fff; width: 100%; justify-content:center;">
                                <i class="fas fa-paper-plane"></i> Send Email
                            </button>
                        </form>
                    </div>

                    <!-- NEW: Message Manager -->
                    <div class="admin-controls" id="admin-message-manager">
                        <button onclick="showAdminTool(null)" class="sketch-btn danger"
                            style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                        <h3>Admin's Note: Message Manager <i class="fas fa-comments"></i></h3>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">(Monitor and clear chat logs)</p>

                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <button onclick="fetchAdminMessages()" class="sketch-btn" style="flex:1;"><i
                                    class="fas fa-sync"></i> Refresh</button>
                            <button onclick="deleteOldMessages()" class="sketch-btn danger" style="flex:1;"><i
                                    class="fas fa-trash-alt"></i> Clear Old (>30 days)</button>
                        </div>

                        <div id="admin-message-list"
                            style="max-height: 300px; overflow-y: auto; border: 2px solid #000; padding: 10px; background: #f9f9f9;">
                            <p style="text-align:center; color:#666;">Click Refresh to load messages.</p>
                        </div>
                    </div>

                    <!-- NEW: Gallery Manager for Landing Page -->
                    <div class="admin-controls" id="admin-gallery-form">
                        <button onclick="showAdminTool(null)" class="sketch-btn danger"
                            style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                        <h3>Admin's Note: Landing Page Gallery <i class="fas fa-images"></i></h3>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">(Upload photos for the main login page)</p>

                        <form onsubmit="uploadGalleryItem(event)" autocomplete="off">
                            <input type="text" id="g-caption" placeholder="Caption (e.g. First Day of School)" required>
                            <input type="file" id="g-file" required accept="image/*">

                            <button type="submit" id="upload-gallery-btn" class="sketch-btn"
                                style="background: #000; color: #fff;">
                                <i class="fas fa-camera"></i> Post to Gallery
                            </button>
                        </form>

                        <hr style="border: 1px dashed #ccc; margin: 15px 0;">
                        <div id="admin-gallery-list" style="max-height: 150px; overflow-y: auto;"></div>
                    </div>

                    <!-- NEW: Storage Monitor -->
                    <div class="admin-controls" id="admin-storage-view">
                        <button onclick="showAdminTool(null)" class="sketch-btn danger"
                            style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                        <h3>Admin's Note: Storage Monitor <i class="fas fa-hdd"></i></h3>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">(Check file counts and usage)</p>

                        <button onclick="fetchStorageStats()" class="sketch-btn"
                            style="background: #000; color: #fff; width: 100%; justify-content: center;">
                            <i class="fas fa-sync"></i> Scan Buckets
                        </button>
                        <div id="storage-stats-display" style="margin-top: 15px;"></div>
                    </div>

                    <!-- NEW: Global Announcement (Main Admin Only) -->
                    <div class="admin-controls" id="admin-announcement-form">
                        <button onclick="showAdminTool(null)" class="sketch-btn danger"
                            style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                        <h3>Admin's Note: Global Announcement <i class="fas fa-bullhorn"></i></h3>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">(Send a real-time popup to everyone online)
                        </p>

                        <form onsubmit="broadcastAnnouncement(event)" autocomplete="off">
                            <textarea id="announcement-msg" placeholder="Type your announcement here..." required
                                style="height: 120px; width: 100%; box-sizing: border-box; border: 2px solid #000; border-radius: 5px; padding: 15px; font-family: 'Patrick Hand'; font-size: 1.2rem; background: #fffdf0;"></textarea>

                            <div
                                style="margin-top: 10px; display: flex; align-items: center; gap: 10px; background: #fff; padding: 10px; border: 2px solid #000; border-radius: 5px;">
                                <label for="announcement-duration"
                                    style="font-family: 'Patrick Hand'; font-size: 1.1rem; white-space: nowrap;">
                                    <i class="fas fa-hourglass-half"></i> Duration (minutes):
                                </label>
                                <input type="number" id="announcement-duration" value="10" min="1" max="1440"
                                    style="width: 80px; padding: 5px; border: 2px solid #000; border-radius: 5px; font-family: 'Patrick Hand'; font-size: 1.1rem;">
                                <small style="color: #666; font-style: italic;">(Default: 10 mins)</small>
                            </div>

                            <button type="submit" id="broadcast-btn" class="sketch-btn"
                                style="background: #6c5ce7; color: #fff; width: 100%; justify-content:center; margin-top: 10px;">
                                <i class="fas fa-broadcast-tower"></i> BROADCAST NOW
                            </button>
                        </form>
                    </div>
                </div>

                <!-- NEW: Promote User -->
                <div class="admin-controls" id="admin-promote-form">
                    <button onclick="showAdminTool(null)" class="sketch-btn danger"
                        style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                    <h3>Admin's Note: Grant Privileges <i class="fas fa-crown"></i></h3>
                    <p style="font-size: 0.9rem; margin-bottom: 10px;">(Give a user Admin access)</p>

                    <form onsubmit="promoteUser(event)" autocomplete="off">
                        <select id="promote-user-select"
                            style="width: 100%; padding: 10px; margin-bottom: 20px; border: none; border-bottom: 2px solid #333; font-family: 'Patrick Hand'; font-size: 1.2rem; background: transparent;">
                            <option value="" disabled selected>Loading users...</option>
                        </select>

                        <div style="text-align: left; margin-bottom: 20px;">
                            <label style="font-weight: bold; display: block; margin-bottom: 10px;">Select Accessible
                                Tools:</label>
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-family: 'Patrick Hand';">
                                <!-- Helper to generating these easier -->
                                <label class="custom-checkbox-container">
                                    <input type="checkbox" class="tool-perm" value="schedule" checked>
                                    <div class="todo-checkbox small">
                                        <div class="charcoal-x"><svg viewBox="0 0 100 100"
                                                style="width:100%; height:100%;">
                                                <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                                <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                            </svg></div>
                                    </div>
                                    <span>Class Sched</span>
                                </label>
                                <label class="custom-checkbox-container">
                                    <input type="checkbox" class="tool-perm" value="homework" checked>
                                    <div class="todo-checkbox small">
                                        <div class="charcoal-x"><svg viewBox="0 0 100 100"
                                                style="width:100%; height:100%;">
                                                <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                                <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                            </svg></div>
                                    </div>
                                    <span>Homework</span>
                                </label>
                                <label class="custom-checkbox-container">
                                    <input type="checkbox" class="tool-perm" value="event" checked>
                                    <div class="todo-checkbox small">
                                        <div class="charcoal-x"><svg viewBox="0 0 100 100"
                                                style="width:100%; height:100%;">
                                                <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                                <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                            </svg></div>
                                    </div>
                                    <span>Events</span>
                                </label>
                                <label class="custom-checkbox-container">
                                    <input type="checkbox" class="tool-perm" value="file" checked>
                                    <div class="todo-checkbox small">
                                        <div class="charcoal-x"><svg viewBox="0 0 100 100"
                                                style="width:100%; height:100%;">
                                                <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                                <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                            </svg></div>
                                    </div>
                                    <span>Files</span>
                                </label>
                                <label class="custom-checkbox-container">
                                    <input type="checkbox" class="tool-perm" value="todo" checked>
                                    <div class="todo-checkbox small">
                                        <div class="charcoal-x"><svg viewBox="0 0 100 100"
                                                style="width:100%; height:100%;">
                                                <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                                <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                            </svg></div>
                                    </div>
                                    <span>To-Do</span>
                                </label>
                                <label class="custom-checkbox-container">
                                    <input type="checkbox" class="tool-perm" value="email" checked>
                                    <div class="todo-checkbox small">
                                        <div class="charcoal-x"><svg viewBox="0 0 100 100"
                                                style="width:100%; height:100%;">
                                                <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                                <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                            </svg></div>
                                    </div>
                                    <span>Email</span>
                                </label>
                                <label class="custom-checkbox-container">
                                    <input type="checkbox" class="tool-perm" value="messages" checked>
                                    <div class="todo-checkbox small">
                                        <div class="charcoal-x"><svg viewBox="0 0 100 100"
                                                style="width:100%; height:100%;">
                                                <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                                <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                            </svg></div>
                                    </div>
                                    <span>Messages</span>
                                </label>
                                <label class="custom-checkbox-container">
                                    <input type="checkbox" class="tool-perm" value="gallery" checked>
                                    <div class="todo-checkbox small">
                                        <div class="charcoal-x"><svg viewBox="0 0 100 100"
                                                style="width:100%; height:100%;">
                                                <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                                <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                            </svg></div>
                                    </div>
                                    <span>Gallery</span>
                                </label>
                                <label class="custom-checkbox-container">
                                    <input type="checkbox" class="tool-perm" value="storage" checked>
                                    <div class="todo-checkbox small">
                                        <div class="charcoal-x"><svg viewBox="0 0 100 100"
                                                style="width:100%; height:100%;">
                                                <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                                <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                            </svg></div>
                                    </div>
                                    <span>Storage</span>
                                </label>
                                <label class="custom-checkbox-container">
                                    <input type="checkbox" class="tool-perm" value="blacklist">
                                    <div class="todo-checkbox small">
                                        <div class="charcoal-x"><svg viewBox="0 0 100 100"
                                                style="width:100%; height:100%;">
                                                <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                                <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                                    stroke-linecap="round" />
                                            </svg></div>
                                    </div>
                                    <span>Black List</span>
                                </label>
                            </div>
                        </div>

                        <button type="submit" class="sketch-btn" style="background: #000; color: #fff; width: 100%;"><i
                                class="fas fa-check-circle"></i> Make Admin</button>
                    </form>
                </div>

                <!-- NEW: Revoke Admin (Main Admin Only) -->
                <div class="admin-controls" id="admin-revoke-form">
                    <button onclick="showAdminTool(null)" class="sketch-btn danger"
                        style="position: absolute; top: 10px; right: 10px; width: auto; margin: 0; padding: 5px 10px; font-size: 0.9rem;">Close</button>
                    <h3>Admin's Note: Revoke Access <i class="fas fa-user-slash"></i></h3>
                    <p style="font-size: 0.9rem; margin-bottom: 10px;">(Demote an Admin back to Student)</p>

                    <form onsubmit="revokeAdmin(event)" autocomplete="off">
                        <select id="revoke-user-select"
                            style="width: 100%; padding: 10px; margin-bottom: 10px; border: none; border-bottom: 2px solid #333; font-family: 'Patrick Hand'; font-size: 1.2rem; background: transparent;">
                            <option value="" disabled selected>Loading admins...</option>
                        </select>
                        <button type="submit" class="sketch-btn danger" style="width: 100%; justify-content: center;"><i
                                class="fas fa-ban"></i> Revoke Access</button>
                    </form>
                </div>
            </div>

            <!-- ================= SCHEDULE TAB ================= -->
            <div id="schedule" class="tab-content">
                <h2><i class="fas fa-clock"></i> Class Schedule</h2>

                <div class="filter-bar">
                    <button class="sketch-btn" onclick="filterSchedule('Monday')">Monday</button>
                    <button class="sketch-btn" onclick="filterSchedule('Tuesday')">Tuesday</button>
                    <button class="sketch-btn" onclick="filterSchedule('Wednesday')">Wednesday</button>
                    <button class="sketch-btn" onclick="filterSchedule('Thursday')">Thursday</button>
                    <button class="sketch-btn" onclick="filterSchedule('Friday')">Friday</button>
                    <button class="sketch-btn" onclick="filterSchedule('Saturday')">Saturday</button>
                    <button class="sketch-btn" onclick="filterSchedule('All')">All</button>
                    <button class="sketch-btn wallpaper-btn" onclick="openWallpaperModal()">
                        <i class="fas fa-camera-retro"></i> Wallpaper
                    </button>
                    <button class="sketch-btn pdf-scanner-btn admin-only hidden" onclick="openPdfScanner()">
                        <i class="fas fa-paste"></i> Paste Schedule
                    </button>
                    <button class="sketch-btn danger admin-only hidden" onclick="deleteAllSchedules()">
                        <i class="fas fa-trash-alt"></i> Delete All Schedules
                    </button>
                </div>

                <h3 id="current-day-label" style="text-align: center; font-size: 1.5rem; color: #57606f;">Weekly View
                </h3>

                <div id="schedule-list" class="grid-container">
                    <div class="loader">Flipping pages...</div>
                </div>
            </div>

            <!-- ================= PLANNER (ASSIGNMENTS & TO-DO) TAB ================= -->
            <div id="assignments" class="tab-content hidden">
                <h2><i class="fas fa-tasks"></i> To Do List</h2>

                <!-- Homework Section -->
                <h3 style="margin-top:20px; border-bottom: 2px dashed #000; padding-bottom:5px;"><i
                        class="fas fa-thumbtack"></i> Homework Assignments</h3>
                <div id="assignment-list" class="grid-container">
                    <div class="loader">Checking backpack...</div>
                </div>

                <!-- Global To-Do Section -->
                <h3 style="margin-top:40px; border-bottom: 2px dashed #000; padding-bottom:5px;"><i
                        class="fas fa-check-double"></i> Class To-Do List</h3>
                <div
                    style="background: #fff740; padding: 10px; border: 2px dashed #000; margin-bottom: 20px; transform: rotate(-0.5deg); font-size: 0.9rem;">
                    <b>NOTE:</b> Mark the task when done! Your classmates will see you finished it. Stay motivated!
                </div>
                <div id="todo-list" style="display: flex; flex-direction: column; gap: 15px;">
                    <div class="loader">Sharpening pencils...</div>
                </div>
            </div>

            <!-- ================= CALENDAR TAB ================= -->
            <div id="calendar" class="tab-content hidden">
                <h2><i class="fas fa-calendar-alt"></i> Upcoming Events</h2>
                <div id="calendar-root"></div> <!-- New Calendar Container -->
            </div>

            <!-- ================= LINKS & FILES TAB ================= -->
            <div id="links" class="tab-content hidden">
                <h2><i class="fas fa-folder-open"></i> Subject Files</h2>

                <!-- Insert above <h3 id="file-filter-label"> -->
                <div style="position: relative; margin-bottom: 15px;">
                    <input type="text" id="file-search" placeholder=" Search filename..." onkeyup="searchFiles()"
                        style="border: 2px solid #000; border-radius: 20px; padding: 8px 15px; background: #fff;">
                </div>

                <!-- Subject Filter Bar (Empty - JS will fill this) -->
                <div class="filter-bar" id="link-filters" style="margin-bottom: 25px;">
                    <!-- JavaScript will automatically put buttons here based on your Schedule -->
                    <button class="sketch-btn" onclick="filterFiles('All')">All</button>
                    <button class="sketch-btn" onclick="filterFiles('General')">General</button>
                </div>

                <!-- The Dynamic File List -->
                <div style="margin-bottom: 30px; min-height: 200px;">
                    <h3 id="file-filter-label" style="color: #666; font-size: 1.2rem;">Showing: All Files</h3>
                    <div id="file-list" class="file-grid">
                        <div class="loader">Opening filing cabinet...</div>
                    </div>
                </div>
                <hr style="border: 2px dashed #a4b0be; margin: 30px 0;">
                <!-- Static Links -->
                <h3><i class="fas fa-external-link-alt"></i> External Tools</h3>
                <div class="grid-container">
                    <a href="https://drive.google.com/drive/folders/1n50vswAbnj1KnoxB0Obp3_vcrouz10CW?usp=drive_link"
                        target="_blank" class="class-card"
                        style="text-decoration: none; color: inherit; text-align: center; border: 2px dashed #00b894;">
                        <i class="fab fa-google-drive" style="font-size: 3rem; color: #00b894;"></i>
                        <h3 style="margin-top: 10px;">Old Archive</h3>
                    </a>

                    <div onclick="openRequestModal()" class="class-card"
                        style="cursor: pointer; text-align: center; border: 2px dashed #0984e3;">
                        <i class="fas fa-user-secret" style="font-size: 3rem; color: #0984e3;"></i>
                        <h3 style="margin-top: 10px;">Secret Request</h3>
                    </div>

                    <div onclick="openFreedomWallModal()" class="class-card"
                        style="cursor: pointer; text-align: center; border: 2px dashed #2d3436;">
                        <i class="fas fa-sticky-note" style="font-size: 3rem; color: #2d3436;"></i>
                        <h3 style="margin-top: 10px;">Post to Freedom Wall</h3>
                    </div>
                </div>


            </div>

            <!-- ================= HELP TAB ================= -->
            <div id="help" class="tab-content hidden">
                <h2><i class="fas fa-question-circle"></i> Student's Guide</h2>

                <div class="grid-container">
                    <div class="class-card" style="transform: rotate(1deg);">
                        <h3><i class="fas fa-book"></i> The Binder</h3>
                        <p>Welcome to your digital binder! Use the <b>colored tabs</b> on the left (or top on mobile) to
                            navigate between your Schedule, Homework, and Reviewers.</p>
                    </div>
                    <div class="class-card" style="transform: rotate(-1deg);">
                        <h3><i class="fas fa-paper-plane"></i> Messaging</h3>
                        <p>Use the floating <b>"MESSAGE SOMEONE"</b> button to chat with classmates. You can see who's
                            online in the sidebar and check your inbox for new notes!</p>
                    </div>
                    <div class="class-card" style="transform: rotate(1.5deg);">
                        <h3><i class="fas fa-eye"></i> File Previewer</h3>
                        <p>No need to download everything! Click on any file in the <b>Files</b> tab to preview PDFs and
                            images instantly before saving them.</p>
                    </div>
                    <div class="class-card" style="transform: rotate(-2deg);">
                        <h3><i class="fas fa-magic"></i> Wallpaper Gen</h3>
                        <p>Create custom schedules for your phone or desktop. Check the <b>Wallpaper</b> button in the
                            Schedule tab for new Glassmorphism effects and custom backgrounds!</p>
                    </div>
                    <div class="class-card" style="transform: rotate(1deg);">
                        <h3><i class="fas fa-clock"></i> Live Tracker</h3>
                        <p>The binder automatically tracks your current class. Look for the <b>"HAPPENING NOW"</b> card
                            at the top of your schedule for quick access to links.</p>
                    </div>
                    <div class="class-card" style="transform: rotate(-1.5deg);">
                        <h3><i class="fas fa-user-secret"></i> Secret Requests</h3>
                        <p>Found a bug? Want to suggest a feature? Use the <b>"Secret Request"</b> card in the Files tab
                            to send an anonymous note to the admin.</p>
                    </div>
                </div>
            </div>

        </div> <!-- End Paper Content -->
    </div> <!-- End Binder -->

    <!-- PDF/Paste Scanner Modal -->
    <div id="pdfScannerModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box"
            style="width: 95%; max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom: 2px dashed #000; padding-bottom: 10px;">
                <h2 style="margin:0;"><i class="fas fa-paste"></i> Paste Schedule Scanner</h2>
                <button onclick="document.getElementById('pdfScannerModal').classList.add('hidden')"
                    class="sketch-btn danger" style="width:auto; padding: 5px 10px;">X</button>
            </div>

            <div id="pdf-upload-zone" style="flex: 1; display: flex; flex-direction: column; gap: 10px;">
                <p style="font-family: 'Patrick Hand'; font-size: 1.2rem; color: #555; margin: 0;">Paste your schedule
                    text from the portal below:</p>
                <textarea id="pdf-paste-input" placeholder="Paste Code, Description, Section, etc. here..."
                    style="flex: 1; border: 2px solid #000; border-radius: 5px; padding: 15px; font-family: 'Patrick Hand'; font-size: 1.1rem; resize: none; background: #fffdf0;"></textarea>
                <button onclick="handlePasteParse()" class="sketch-btn"
                    style="width: 100%; background: #000; color: #fff; margin-top: 5px; font-size: 1.2rem;">
                    <i class="fas fa-magic"></i> EXTRACT CLASSES
                </button>
            </div>

            <div id="pdf-parsing-loader" class="hidden"
                style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; color: #0984e3;"></i>
                <p style="font-family: 'Patrick Hand'; font-size: 1.5rem; margin-top: 15px;">Reading your schedule...
                </p>
            </div>

            <div id="pdf-review-zone" class="hidden"
                style="flex: 1; overflow-y: auto; text-align: left; padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0; color: #2d3436;">Review Extracted Classes:</h3>
                    <button onclick="resetPdfScanner()" class="sketch-btn"
                        style="width: auto; padding: 5px 10px; font-size: 0.9rem;">Back</button>
                </div>
                <div id="extracted-classes-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- Classes will be listed here -->
                </div>
            </div>

            <div id="pdf-scanner-footer" class="hidden"
                style="margin-top: 15px; border-top: 2px dashed #000; padding-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="saveExtractedClasses()" id="btn-save-extracted" class="sketch-btn"
                    style="width: auto; background: #00b894; color: #fff; font-size: 1.1rem; padding: 10px 25px;">
                    <i class="fas fa-save"></i> Save All to Schedule
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Class Modal -->
    <div id="editClassModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box" style="text-align: left; max-width: 550px; height: 85vh; overflow-y: auto;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom: 2px solid #000; padding-bottom:10px; position: sticky; top: -30px; background: white; z-index: 10; padding-top: 10px;">
                <h2 style="margin:0; font-size: 1.5rem;"><i class="fas fa-edit"></i> Edit Class Details</h2>
                <button onclick="document.getElementById('editClassModal').classList.add('hidden')"
                    class="sketch-btn danger" style="width:auto; padding: 5px 10px;">X</button>
            </div>

            <input type="hidden" id="edit-class-id">

            <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                <div>
                    <label style="display:block; font-family:'Patrick Hand'; font-size: 1.1rem;">Day of Week:</label>
                    <select id="edit-class-day"
                        style="width:100%; padding:8px; border:2px solid #000; border-radius: 5px; font-family:'Patrick Hand';">
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                    </select>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display:block; font-family:'Patrick Hand'; font-size: 1.1rem;">Subject
                            Code:</label>
                        <input type="text" id="edit-class-code"
                            style="width:100%; padding:8px; border:2px solid #000; border-radius: 5px; font-family:'Patrick Hand';">
                    </div>
                    <div>
                        <label style="display:block; font-family:'Patrick Hand'; font-size: 1.1rem;">Subject
                            Name:</label>
                        <input type="text" id="edit-class-name"
                            style="width:100%; padding:8px; border:2px solid #000; border-radius: 5px; font-family:'Patrick Hand';">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display:block; font-family:'Patrick Hand'; font-size: 1.1rem;">Start Time:</label>
                        <input type="time" id="edit-class-start"
                            style="width:100%; padding:8px; border:2px solid #000; border-radius: 5px;">
                    </div>
                    <div>
                        <label style="display:block; font-family:'Patrick Hand'; font-size: 1.1rem;">End Time:</label>
                        <input type="time" id="edit-class-end"
                            style="width:100%; padding:8px; border:2px solid #000; border-radius: 5px;">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display:block; font-family:'Patrick Hand'; font-size: 1.1rem;">Room / Lab:</label>
                        <input type="text" id="edit-class-room"
                            style="width:100%; padding:8px; border:2px solid #000; border-radius: 5px; font-family:'Patrick Hand';">
                    </div>
                    <div>
                        <label style="display:block; font-family:'Patrick Hand'; font-size: 1.1rem;">Instructor:</label>
                        <input type="text" id="edit-class-instructor"
                            style="width:100%; padding:8px; border:2px solid #000; border-radius: 5px; font-family:'Patrick Hand';">
                    </div>
                </div>

                <div>
                    <label style="display:block; font-family:'Patrick Hand'; font-size: 1.1rem;">Google Meet
                        Link:</label>
                    <input type="text" id="edit-class-meet" placeholder="https://meet.google.com/..."
                        style="width:100%; padding:8px; border:2px solid #000; border-radius: 5px; font-family:'Patrick Hand';">
                </div>

                <div>
                    <label style="display:block; font-family:'Patrick Hand'; font-size: 1.1rem;">Google Classroom
                        Link:</label>
                    <input type="text" id="edit-class-classroom" placeholder="https://classroom.google.com/..."
                        style="width:100%; padding:8px; border:2px solid #000; border-radius: 5px; font-family:'Patrick Hand';">
                </div>

                <div style="margin-top: 10px;">
                    <label class="custom-checkbox-container" style="font-size: 1rem;">
                        <input type="checkbox" id="sync-subject-links">
                        <div class="todo-checkbox small">
                            <div class="charcoal-x"><svg viewBox="0 0 100 100" style="width:100%; height:100%;">
                                    <path d="M 20,20 L 80,80" fill="none" stroke="#000" stroke-width="12"
                                        stroke-linecap="round" />
                                    <path d="M 80,20 L 20,80" fill="none" stroke="#000" stroke-width="12"
                                        stroke-linecap="round" />
                                </svg></div>
                        </div>
                        <span>Apply links to ALL instances of this subject</span>
                    </label>
                </div>
            </div>

            <button onclick="saveClassEdit()" class="sketch-btn"
                style="width:100%; background:#000; color:#fff; font-size: 1.3rem; padding: 12px; margin-top: 20px;">
                <i class="fas fa-save"></i> SAVE CHANGES
            </button>
        </div>
    </div>

    <!-- Hand-drawn Up Arrow -->
    <div class="floating-action" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <i class="fas fa-arrow-up" style="filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.1));"></i>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Request Modal -->
    <div id="requestModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box" style="text-align: left;">
            <h2 style="margin-top:0;">Drop a Note</h2>
            <p>Got a request or a secret question for the admin?</p>
            <textarea id="req-content" placeholder="Type here..."
                style="width:100%; height:100px; font-family:'Patrick Hand'; font-size:1.2rem; padding:10px; border:2px solid #000;"></textarea>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button onclick="closeRequestModal()" class="sketch-btn">Cancel</button>
                <button onclick="submitRequest()" class="sketch-btn" style="background:#000; color:#fff;">Send</button>
            </div>
        </div>
    </div>

    <!-- Freedom Wall Modal -->
    <div id="freedomWallModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box"
            style="width: 95%; max-width: 1000px; height: 80vh; display: flex; flex-direction: column; padding: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0;"><i class="fas fa-sticky-note"></i> Freedom Wall</h2>
                <button onclick="document.getElementById('freedomWallModal').classList.add('hidden')"
                    class="sketch-btn danger" style="width:auto; margin:0; padding: 5px 15px;">CLOSE</button>
            </div>
            <div id="freedom-wall-board" style="flex: 1; margin-bottom: 15px;">
                <!-- Notes injected here -->
            </div>
            <!-- Admin Controls for Freedom Wall -->
            <div id="fw-admin-controls" class="hidden"
                style="margin-bottom: 10px; display: flex; gap: 10px; justify-content: center;">
                <button onclick="autoArrangeNotes()" class="sketch-btn"
                    style="width: auto; background: #0984e3; color: #fff; font-size: 1rem; padding: 5px 15px;">AUTO
                    ARRANGE</button>
                <button onclick="scatterNotes()" class="sketch-btn"
                    style="width: auto; background: #e67e22; color: #fff; font-size: 1rem; padding: 5px 15px;">SCATTER</button>
            </div>
            <div style="margin-top: 10px; display:flex; gap:10px; justify-content:center; align-items:center;">
                <div class="color-option selected" onclick="selectColor(this, 'white')" style="background:#fff;"
                    title="Plain"></div>
                <div class="color-option" onclick="selectColor(this, 'lined')"
                    style="background: repeating-linear-gradient(transparent, transparent 4px, #a4b0be 5px); background-color: #fff;"
                    title="Lined"></div>
                <div class="color-option" onclick="selectColor(this, 'yellow')" style="background:#fff740;"
                    title="Yellow"></div>
                <div class="color-option" onclick="selectColor(this, 'pink')" style="background:#ff7eb9;" title="Pink">
                </div>
                <div class="color-option" onclick="selectColor(this, 'blue')" style="background:#7afcff;" title="Blue">
                </div>
                <div class="color-option" onclick="selectColor(this, 'green')" style="background:#98ff98;"
                    title="Green"></div>
                <input type="hidden" id="fw-binder-color" value="white">
            </div>
            <div
                style="margin-top: 15px; display: flex; gap: 10px; align-items: center; background: #f1f2f6; padding: 10px; border: 2px dashed #000; border-radius: 5px;">
                <i class="fas fa-pencil-alt" style="font-size: 1.5rem;"></i>
                <input type="text" id="fw-content" placeholder="Write on the wall..." maxlength="60"
                    style="flex: 1; border: none; background: transparent; border-bottom: 2px solid #000; font-family: 'Patrick Hand'; font-size: 1.3rem; outline: none;"
                    onkeydown="if(event.key === 'Enter') postFreedomWallNote()">
                <button onclick="postFreedomWallNote()" class="sketch-btn"
                    style="width: auto; margin: 0; background: #2d3436; color: #fff;">STICK IT</button>
            </div>
        </div>
    </div>

    <!-- Inbox Modal -->
    <div id="inboxModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box"
            style="width: 95%; max-width: 400px; height: 60vh; display: flex; flex-direction: column;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom: 2px dashed #000; padding-bottom: 10px;">
                <h2 style="margin:0;"><i class="fas fa-envelope-open-text"></i> Inbox</h2>
                <button onclick="document.getElementById('inboxModal').classList.add('hidden')"
                    class="sketch-btn danger" style="width:auto; padding: 5px 10px;">X</button>
            </div>
            <div id="inbox-list" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                <!-- Conversations injected here -->
            </div>
        </div>
    </div>

    <!-- Floating Message Button -->

    <div class="fab-message" onclick="openNewChatModal()" title="Message Someone">
        <i class="fas fa-paper-plane"></i>
        <span>MESSAGE SOMEONE</span>
    </div>

    <!-- New Chat / Recipient Selection Modal -->
    <div id="newChatModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box"
            style="width: 95%; max-width: 400px; height: 70vh; display: flex; flex-direction: column;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom: 2px dashed #000; padding-bottom: 10px;">
                <h2 style="margin:0;"><i class="fas fa-user-plus"></i> Send Note To...</h2>
                <button onclick="document.getElementById('newChatModal').classList.add('hidden')"
                    class="sketch-btn danger" style="width:auto; padding: 5px 10px;">X</button>
            </div>
            <input type="text" id="recipient-search" placeholder=" Search classmate..." onkeyup="filterRecipients()"
                style="border: 2px solid #000; border-radius: 5px; padding: 8px; margin-bottom: 15px; background: #fff;">
            <div id="recipient-list"
                style="flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                <!-- Classmates injected here -->
            </div>
        </div>
    </div>

    <!-- Notification Sound -->
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"
        preload="auto"></audio>

    <!-- Chat Modal -->
    <div id="chatModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box" style="width: 95%; max-width: 500px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 id="chat-with-name" style="margin:0;"><i class="fas fa-comments"></i> Chat</h2>
                <button onclick="closeChatModal()" class="sketch-btn danger"
                    style="width:auto; padding: 5px 10px;">X</button>
            </div>
            <div id="chat-history" class="chat-container"></div>
            <form onsubmit="sendChatMessage(event)" class="chat-input-area">
                <input type="hidden" id="chat-target-id">
                <input type="text" id="chat-input" placeholder="Write a note..." required autocomplete="off"
                    style="margin:0; border: 2px solid #000;">
                <button type="submit" class="sketch-btn" style="width:auto; margin:0; background:#000; color:#fff;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Wallpaper Generator Modal -->
    <div id="wallpaperModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box">
            <h2><i class="fas fa-camera-retro"></i> Get Wallpaper</h2>
            <p>Select your device size:</p>
            <select id="wp-size-select"
                style="margin-bottom: 20px; font-family: 'Patrick Hand'; font-size: 1.2rem; padding: 10px; border: 2px solid #000; background: #fff; width: 100%;">
                <option value="auto">Current Screen (Adaptive)</option>
                <option value="1080,1920">Standard Phone (9:16)</option>
                <option value="1170,2532">Tall Phone / iPhone (19.5:9)</option>
                <option value="1290,2796">Max / Ultra Phone</option>
                <option value="1536,2048">Tablet / iPad (Portrait)</option>
                <option value="1920,1080">Desktop / Laptop (16:9)</option>
            </select>
            <p>Select Background Style:</p>
            <select id="wp-bg-select" onchange="toggleCustomBgInput(this)"
                style="margin-bottom: 20px; font-family: 'Patrick Hand'; font-size: 1.2rem; padding: 10px; border: 2px solid #000; background: #fff; width: 100%;">
                <option value="paper">Classic Paper (Wimpy Style)</option>
                <option value="midnight">Midnight Glass</option>
                <option value="sunset">Sunset Glass</option>
                <option value="ocean">Ocean Glass</option>
                <option value="forest">Forest Glass</option>
                <option value="custom">Custom Image (Upload)</option>
                <option value="ipown">Ipown Pormat (Modern)</option>
            </select>
            <input type="file" id="wp-custom-bg" accept="image/*" class="hidden"
                style="margin-bottom: 20px; font-family: 'Patrick Hand'; font-size: 1rem; width: 100%; border: 2px dashed #000; padding: 10px;">
            <button onclick="generateWallpaperFromSelect(event)" class="sketch-btn"
                style="background:#000; color:#fff; margin-bottom:10px; width:100%; justify-content:center;">
                <i class="fas fa-magic"></i> Generate Wallpaper
            </button>
            <button onclick="document.getElementById('wallpaperModal').classList.add('hidden')"
                class="sketch-btn danger">Cancel</button>
        </div>
    </div>

    <!-- Status Edit Modal -->
    <div id="statusModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box">
            <h2><i class="fas fa-id-badge"></i> Edit Status</h2>
            <p>How are you feeling today?</p>
            <input type="text" id="statusInput" placeholder="e.g. Certified Member" maxlength="20"
                style="margin-bottom: 20px; font-family: 'Patrick Hand'; font-size: 1.2rem; padding: 10px; border: 2px solid #000; background: #fff; width: 100%; text-align: center; box-sizing: border-box;">
            <button onclick="saveUserStatus()" class="sketch-btn"
                style="background:#000; color:#fff; margin-bottom:10px; width:100%; justify-content:center;">
                <i class="fas fa-save"></i> Save Status
            </button>
            <button onclick="document.getElementById('statusModal').classList.add('hidden')"
                class="sketch-btn danger">Cancel</button>
        </div>
    </div>

    <!-- Name Edit Modal -->
    <div id="editNameModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box">
            <h2><i class="fas fa-signature"></i> Change Name</h2>
            <p>What should we call you now?</p>
            <input type="text" id="nameChangeInput" placeholder="Enter new name" maxlength="30"
                style="margin-bottom: 20px; font-family: 'Patrick Hand'; font-size: 1.2rem; padding: 10px; border: 2px solid #000; background: #fff; width: 100%; text-align: center; box-sizing: border-box;">
            <button onclick="saveUserName()" class="sketch-btn"
                style="background:#000; color:#fff; margin-bottom:10px; width:100%; justify-content:center;">
                <i class="fas fa-check"></i> Update Name
            </button>
            <button onclick="document.getElementById('editNameModal').classList.add('hidden')"
                class="sketch-btn danger">Cancel</button>
        </div>
    </div>

    <!-- Add Event Modal (Calendar) -->
    <div id="addEventModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box">
            <h2><i class="fas fa-calendar-plus"></i> New Event</h2>
            <p id="addEventDateLabel" style="font-weight:bold; margin-bottom:15px;"></p>
            <form onsubmit="addEventFromCalendar(event)" autocomplete="off">
                <input type="hidden" id="cal-e-date">
                <input type="text" id="cal-e-title" placeholder="Event Name" required
                    style="margin-bottom: 10px; width: 100%; box-sizing: border-box;">
                <input type="text" id="cal-e-desc" placeholder="Description (Optional)"
                    style="margin-bottom: 20px; width: 100%; box-sizing: border-box;">

                <button type="submit" class="sketch-btn"
                    style="background:#000; color:#fff; margin-bottom:10px; width:100%; justify-content:center;">Save
                    Event</button>
                <button type="button" onclick="document.getElementById('addEventModal').classList.add('hidden')"
                    class="sketch-btn danger" style="width:100%; justify-content:center;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Calendar Prompt Modal -->
    <div id="calendarPromptModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box">
            <h2><i class="fab fa-google"></i> Schedule Work Time</h2>
            <div
                style="background: #f1f2f6; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px dashed #000;">
                <p style="margin:0; font-weight:bold; color:#d63031;">DEADLINE:</p>
                <p id="cal-prompt-deadline" style="margin:0; font-size:1.1rem;"></p>
            </div>
            <p>Aba ano kelan mo gagawin ya?</p>

            <input type="hidden" id="cal-prompt-task-json">

            <div style="margin-bottom: 20px;">
                <label style="font-family:'Patrick Hand'; display:block;">Start Date:</label>
                <input type="date" id="cal-prompt-start"
                    style="width:100%; padding:10px; font-family:'Patrick Hand'; font-size:1.1rem; border:2px solid #000;">
            </div>

            <button onclick="confirmAddToCalendar()" class="sketch-btn"
                style="background:#0984e3; color:#fff; margin-bottom:10px; width:100%; justify-content:center;">
                <i class="fas fa-calendar-plus"></i> Add to Calendar
            </button>
            <button onclick="document.getElementById('calendarPromptModal').classList.add('hidden')"
                class="sketch-btn danger" style="width:100%; justify-content:center;">Cancel</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="js/common.js"></script>
    <script src="js/dashboard.js?v=202405152300"></script> <!-- Update this version number on every deployment -->
    <script src="js/messaging.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/pdf-scanner.js"></script>

    <!-- PREVIEWER FEATURE & FILE LOGIC (Added Inline) -->
    <script>
        // --- CONFIGURATION ---
        // SUPABASE_URL and SUPABASE_KEY are loaded from common.js

        // Use existing client if available, else create
        const sb = window.db || supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let globalFiles = [];

        // --- 1. PREVIEW MODAL ---
        window.openFilePreview = async function (url, title, fileId) {
            if (!url) return alert('No file link available.');

            // --- TRACKING (Persistent Mode) ---
            try {
                const currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');
                if (currentUser && fileId) {
                    const logPayload = {
                        type: 'file_view',
                        u: currentUser.name,
                        a: currentUser.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=random`,
                        fid: fileId,
                        t: new Date().toISOString()
                    };

                    // Use 'notes' table with a hidden color for logging (proven pattern in group-chat.js)
                    await window.db.from('notes').insert([{
                        content: JSON.stringify(logPayload),
                        x_pos: 0, y_pos: 0, rotation: 0,
                        color: 'FILE_VIEW',
                        likes: 0
                    }]);
                    console.log(`View logged for file ${fileId}`);
                }
            } catch (err) {
                console.warn("View tracking failed:", err);
            }

            const existing = document.getElementById('filePreviewModal');
            if (existing) existing.remove();

            const isPdf = url.toLowerCase().includes('.pdf');
            const isImg = url.match(/\.(jpeg|jpg|gif|png|webp)$/i);

            const loaderHtml = `
                <div id="previewLoader" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#555;">
                    <i class="fas fa-spinner fa-spin" style="font-size:3rem;"></i>
                    <p style="font-family:'Patrick Hand'; font-size:1.5rem; margin-top:10px;">Unfolding paper...</p>
                </div>
            `;

            let contentHtml = '';

            if (isPdf) {
                contentHtml = `${loaderHtml}<iframe src="${url}" style="width:100%; height:100%; border:none; display:none;" onload="this.style.display='block'; document.getElementById('previewLoader').style.display='none';" title="${title}"></iframe>`;
            } else if (isImg) {
                contentHtml = `${loaderHtml}<div style="display:flex; justify-content:center; align-items:center; width:100%; height:100%;">
                    <img src="${url}" style="max-width:100%; max-height:100%; object-fit:contain; display:none;" onload="this.style.display='block'; document.getElementById('previewLoader').style.display='none';">
                </div>`;
            } else {
                contentHtml = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center;">
                        <i class="fas fa-file-download" style="font-size:4rem; margin-bottom:20px;"></i>
                        <p>Preview not available for this file type.</p>
                        <a href="${url}" target="_blank" download class="preview-modal-btn" style="background:#000; color:#fff; padding:10px 20px; text-decoration:none; border: 2px solid #000; border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; font-family: 'Patrick Hand';">Download File</a>
                    </div>
                `;
            }

            const modalHtml = `
                <div id="filePreviewModal" class="file-preview-overlay">
                    <div class="file-preview-box">
                        <div class="preview-header">
                            <h3><i class="fas fa-eye"></i> ${title}</h3>
                            <div class="preview-actions">
                                <a href="${url}" target="_blank" download style="text-decoration:none;">
                                    <button class="sketch-btn" style="background:#0984e3; color:#fff; padding: 8px 15px; margin:0;" title="Download">
                                        <i class="fas fa-download"></i> <span class="hide-mobile">DOWNLOAD</span>
                                    </button>
                                </a>
                                <button class="sketch-btn danger" onclick="document.getElementById('filePreviewModal').remove()" style="padding: 8px 15px; margin:0;">
                                    <i class="fas fa-times"></i> <span class="hide-mobile">CLOSE</span>
                                </button>
                            </div>
                        </div>
                        <div class="preview-body">
                            ${contentHtml}
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // --- NEW: VIEW FILE LOG (WHO CLICKED) ---
        window.viewFileHistory = async function (fileId, title) {
            console.log("Fetching viewer log for file ID:", fileId);

            // 1. Create Loading Overlay
            const overlay = document.createElement('div');
            overlay.className = 'wimpy-modal-overlay';
            overlay.id = 'viewer-log-modal';
            overlay.innerHTML = `
                <div class="wimpy-modal-box" style="max-width:400px; text-align:left;">
                    <h2 style="margin-top:0;"><i class="fas fa-users-viewfinder"></i> Recently Seen By</h2>
                    <p style="font-size:0.9rem; color:#666; margin-top:-10px; font-family:'Patrick Hand';">File: ${title}</p>
                    <div id="viewer-list" style="max-height:300px; overflow-y:auto; margin:15px 0;">
                        <div class="loader">Checking the paper trail...</div>
                    </div>
                    <button onclick="document.getElementById('viewer-log-modal').remove()" class="sketch-btn" style="width:100%; background:#000; color:#fff;">GOT IT</button>
                </div>
            `;
            document.body.appendChild(overlay);

            try {
                // Fetch from notes table where color is FILE_VIEW
                const { data: logs, error } = await window.db
                    .from('notes')
                    .select('content, created_at')
                    .eq('color', 'FILE_VIEW')
                    .order('created_at', { ascending: false })
                    .limit(50); // Fetch more to filter

                if (error) throw error;

                // Filter for this specific file in JS
                const fileViewers = (logs || [])
                    .map(log => {
                        try { return JSON.parse(log.content); } catch (e) { return null; }
                    })
                    .filter(v => v && v.fid == fileId)
                    .slice(0, 10); // Show last 10 unique views or just last 10 views

                const listEl = document.getElementById('viewer-list');
                if (!fileViewers || fileViewers.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center; font-style:italic; padding: 20px;">Nobody has viewed this file yet. Be the first!</p>';
                    return;
                }

                // 3. Render List
                listEl.innerHTML = fileViewers.map(v => {
                    const avatar = v.a || `https://ui-avatars.com/api/?name=${encodeURIComponent(v.u)}&background=random`;
                    const timeDisp = window.timeAgo ? window.timeAgo(v.t) : new Date(v.t).toLocaleString();
                    return `
                        <div style="display:flex; align-items:center; gap:12px; padding:10px; border-bottom:1px dashed #ccc;">
                            <img src="${avatar}" style="width:35px; height:35px; border-radius:50%; border:1px solid #000;">
                            <div style="flex:1;">
                                <div style="font-family:'Patrick Hand'; font-size:1.1rem; font-weight:bold;">${typeof escapeHTML === 'function' ? escapeHTML(v.u) : v.u}</div>
                                <div style="font-size:0.75rem; color:#d63031;">${timeDisp}</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error("Failed to load viewers:", err);
                document.getElementById('viewer-list').innerHTML = '<p>Error loading log.</p>';
            }
        }

        // --- 2. FETCH & RENDER FILES ---
        window.refreshFiles = async function () {
            const list = document.getElementById('file-list');
            if (!list) return;

            const { data, error } = await sb.from('shared_files')
                .select('*')
                .neq('subject', 'LandingGallery')
                .not('subject', 'like', 'Receipt-%')
                .order('created_at', { ascending: false });
            if (error) return console.error(error);

            globalFiles = data || [];
            renderFileList(globalFiles);
        }

        window.renderFileList = function (files) {
            const list = document.getElementById('file-list');
            if (!files.length) { list.innerHTML = '<p>No files found.</p>'; return; }

            // Check Admin
            const currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');
            const isAdmin = currentUser && currentUser.sr_code === 'ADMIN';

            const dateLimit = new Date();
            dateLimit.setDate(dateLimit.getDate() - 3);

            list.innerHTML = files.map(file => {
                const safeUrl = (file.file_url || '').replace(/\\/g, "\\\\").replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const safeTitle = (file.title || 'File').replace(/\\/g, "\\\\").replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const subjectCode = file.subject || 'General';
                const subject = (subjectCode === 'General') ? 'General' : (window.subjectMapping ? window.subjectMapping[subjectCode] || subjectCode : subjectCode);
                const displayTitle = typeof escapeHTML === 'function' ? escapeHTML(file.title) : safeTitle;

                const createdAt = new Date(file.created_at);
                const isNew = createdAt > dateLimit && subject !== 'General';
                const badgeHtml = isNew ? `<span class="new-badge-sketch" style="background:#ff4757; color:#fff; padding:2px 6px; border-radius:4px; font-size:0.7rem; margin-left:5px; border:1px solid #000; display:inline-block; transform:rotate(5deg);">NEW!</span>` : '';

                // Better Icon Logic
                let iconClass = 'fa-file';
                let iconColor = '#2f3542';
                const fType = (file.file_type || '').toLowerCase();
                if (fType.includes('pdf')) { iconClass = 'fa-file-pdf'; iconColor = '#d63031'; }
                else if (fType.includes('image')) { iconClass = 'fa-file-image'; iconColor = '#00b894'; }
                else if (fType.includes('word')) { iconClass = 'fa-file-word'; iconColor = '#0984e3'; }
                else if (fType.includes('ppt')) { iconClass = 'fa-file-powerpoint'; iconColor = '#e17055'; }
                else if (fType.includes('video')) { iconClass = 'fa-file-video'; iconColor = '#6c5ce7'; }

                const deleteBtn = isAdmin ? `<button onclick="event.stopPropagation(); deleteFile('${file.id}')" class="sketch-btn danger" style="position:absolute; top:-5px; right:-5px; padding: 4px 8px; font-size: 0.7rem; z-index: 50; border-radius: 6px; transform: rotate(5deg); box-shadow: 2px 2px 0 #000;">DEL</button>` : '';

                return `
                <div class="file-card-mini" onclick="openFilePreview('${safeUrl}', '${safeTitle}', '${file.id}')" style="animation-delay: ${Math.random() * 0.5}s;">
                    ${deleteBtn}
                    <div class="file-icon-box" style="border-color: ${iconColor}; color: ${iconColor};">
                        <i class="fas ${iconClass}"></i>
                    </div>
                    <div class="file-info-main">
                        <div class="file-subject-label" style="display:flex; align-items:center; gap:5px;">
                            <span style="color:${iconColor}; font-weight:bold; font-size: 0.7rem;">${subject}</span>
                            ${badgeHtml}
                        </div>
                        <div class="file-title-text" style="font-weight:bold; font-size:1rem; line-height:1.2; margin-top:2px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${displayTitle}</div>
                        
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; border-top: 1px dashed #eee; padding-top: 8px;">
                            <span style="font-size:0.7rem; color:#666;"><i class="fas fa-clock"></i> ${timeAgo ? timeAgo(file.created_at) : createdAt.toLocaleDateString()}</span>
                            <div style="display:flex; gap:10px;">
                                <button onclick="event.stopPropagation(); viewFileHistory('${file.id}', '${safeTitle}')" class="sketch-icon-btn" title="See who viewed this" style="background:none; border:none; color:#fdcb6e; cursor:pointer; font-size:0.9rem;">
                                    <i class="fas fa-users-viewfinder"></i>
                                </button>
                                <button onclick="event.stopPropagation(); copyToClipboard('${safeUrl}')" class="sketch-icon-btn" title="Copy Direct Link" style="background:none; border:none; color:#636e72; cursor:pointer; font-size:0.9rem;">
                                    <i class="fas fa-link"></i>
                                </button>
                                <button class="sketch-icon-btn" title="Preview" style="background:none; border:none; color:#0984e3; cursor:pointer; font-size:0.9rem;">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // Override Search/Filter
        window.searchFiles = function () { const q = document.getElementById('file-search').value.toLowerCase(); renderFileList(globalFiles.filter(f => f.title.toLowerCase().includes(q) || f.subject.toLowerCase().includes(q))); }
        window.filterFiles = function (s) {
            const displayName = (s === 'All' || s === 'General') ? s : (window.subjectMapping ? window.subjectMapping[s] || s : s);
            document.getElementById('file-filter-label').innerText = 'Showing: ' + displayName;
            renderFileList(s === 'All' ? globalFiles : globalFiles.filter(f => f.subject === s));
        }

        // Override deleteFile to use the inline refresh logic
        window.deleteFile = async function (id) {
            if (window.showWimpyConfirm && !await showWimpyConfirm('Delete this file?')) return;
            if (!window.showWimpyConfirm && !confirm('Delete this file?')) return;

            const { error } = await sb.from('shared_files').delete().eq('id', id);
            if (error) {
                if (window.showToast) showToast('Error deleting file.');
                else alert('Error deleting file.');
            } else {
                if (window.showToast) showToast('File removed.');
                refreshFiles();
            }
        }

        // Override loadFiles to maintain consistency with dashboard.js calls
        window.loadFiles = async function (subject) {
            await refreshFiles();
            if (subject && subject !== 'All') filterFiles(subject);
        }

        // Load on start (Delayed slightly to ensure DOM is ready)
        document.addEventListener('DOMContentLoaded', () => setTimeout(refreshFiles, 1000));

        // --- CUSTOM STATUS LOGIC ---
        window.editUserStatus = function () {
            // FIX: Use global user from dashboard.js (Custom Auth)
            const currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');

            if (!currentUser) {
                alert("Please log in to change your status.");
                return;
            }

            const el = document.getElementById('user-status-text');
            const current = el.innerText;

            document.getElementById('statusInput').value = current;
            document.getElementById('statusModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('statusInput').focus(), 100);
        }

        window.saveUserStatus = async function () {
            const newStatus = document.getElementById('statusInput').value.trim();
            const el = document.getElementById('user-status-text');
            const current = el.innerText;
            const modal = document.getElementById('statusModal');

            if (!newStatus) return alert("Status cannot be empty!");

            modal.classList.add('hidden');

            if (newStatus !== current) {
                el.innerText = newStatus;

                const currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');

                // Save to 'user_statuses' table in Supabase
                const { error } = await sb.from('user_statuses').upsert({
                    user_id: currentUser.id,
                    status: newStatus
                });

                if (error) {
                    console.error("Status save failed:", error);
                    alert("Save failed: " + (error.message || "Permission denied"));
                    el.innerText = current; // Revert on error
                } else {
                    showToast("Status updated!");
                }
            }
        }

        // --- NAME CHANGE LOGIC ---
        window.editUserName = function () {
            const currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');
            if (!currentUser) return alert("Please log in first.");

            document.getElementById('nameChangeInput').value = currentUser.name;
            document.getElementById('editNameModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('nameChangeInput').focus(), 100);
        }

        window.saveUserName = async function () {
            const newName = document.getElementById('nameChangeInput').value.trim();
            const modal = document.getElementById('editNameModal');
            let currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');

            if (!newName) return alert("Name cannot be empty!");
            if (!currentUser) return;
            if (newName === currentUser.name) return modal.classList.add('hidden');

            if (window.showWimpyConfirm && !await showWimpyConfirm(`Change your name to "${newName}"?`)) return;

            modal.classList.add('hidden');

            // Show loading toast if available
            if (window.showToast) showToast("Updating your ID card...");

            // 1. Update Supabase
            const { error } = await sb.from('students')
                .update({ name: newName })
                .eq('id', currentUser.id);

            if (error) {
                console.error("Name update failed:", error);
                alert("Could not update name: " + error.message);
                return;
            }

            // 2. Update local state
            currentUser.name = newName;
            window.user = currentUser;

            // 3. Update Storage (Check both for safety)
            localStorage.setItem('wimpy_user', JSON.stringify(currentUser));
            if (sessionStorage.getItem('wimpy_user')) sessionStorage.setItem('wimpy_user', JSON.stringify(currentUser));

            // 4. Update UI
            const welcomeEl = document.getElementById('welcome-msg');
            if (welcomeEl) {
                welcomeEl.innerText = `Hey ${newName}! 2nd Sem na, aral mabuti.`;
            }

            // 5. Update Real-time Presence
            if (window.refreshPresence) window.refreshPresence();

            if (window.showToast) showToast("Name updated successfully!");
        }
        // Init Status
        async function initUserStatus() {
            const currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');
            if (currentUser) {
                const { data } = await sb.from('user_statuses').select('status').eq('user_id', currentUser.id).maybeSingle();
                if (data && data.status) {
                    const el = document.getElementById('user-status-text');
                    if (el) el.innerText = data.status;
                }
            }
        }

        // Run on load (delayed slightly to ensure dashboard.js loads user)
        document.addEventListener('DOMContentLoaded', () => setTimeout(initUserStatus, 1000));

        // --- WALLPAPER GENERATOR LOGIC ---
        window.openWallpaperModal = function () {
            document.getElementById('wallpaperModal').classList.remove('hidden');
            updateWallpaperOptions();
        }

        window.updateWallpaperOptions = function () {
            const sizeSelect = document.getElementById('wp-size-select');
            const bgSelect = document.getElementById('wp-bg-select');
            const ipownOption = bgSelect.querySelector('option[value="ipown"]');

            let isMobile = false;
            const val = sizeSelect.value;

            if (val === 'auto') {
                isMobile = window.innerWidth <= 768; // Simple width check for "Mobile"
            } else {
                const [w, h] = val.split(',').map(Number);
                isMobile = h > w; // Portrait = Mobile assumption
            }

            if (isMobile) {
                ipownOption.style.display = 'block';
                ipownOption.disabled = false;
            } else {
                ipownOption.style.display = 'none';
                ipownOption.disabled = true;
                if (bgSelect.value === 'ipown') bgSelect.value = 'paper'; // Reset if invalid
            }
        }

        // Add listener to Size Select
        document.getElementById('wp-size-select').addEventListener('change', updateWallpaperOptions);

        window.toggleCustomBgInput = function (select) {
            const input = document.getElementById('wp-custom-bg');
            if (select.value === 'custom') input.classList.remove('hidden');
            else input.classList.add('hidden');
        }

        window.generateWallpaperFromSelect = function (e) {
            const val = document.getElementById('wp-size-select').value;
            const bgStyle = document.getElementById('wp-bg-select').value;
            const fileInput = document.getElementById('wp-custom-bg');

            // Capture button reference immediately because e.currentTarget is null in async callbacks
            const btn = e.currentTarget;

            let w, h;
            if (val === 'auto') {
                w = Math.round(window.screen.width * (window.devicePixelRatio || 1));
                h = Math.round(window.screen.height * (window.devicePixelRatio || 1));
            } else {
                [w, h] = val.split(',').map(Number);
            }

            if (bgStyle === 'custom' && fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function (evt) {
                    // Pass a mock event object with the captured button
                    generateWallpaper(w, h, bgStyle, { currentTarget: btn }, evt.target.result);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                if (bgStyle === 'custom') {
                    alert("Please select an image file first!");
                    return;
                }
                generateWallpaper(w, h, bgStyle, e);
            }
        }

        window.showWallpaperPreview = function (dataUrl, filename) {
            const overlay = document.createElement('div');
            overlay.className = 'wimpy-modal-overlay';
            overlay.id = 'wp-preview-overlay';
            overlay.style.zIndex = '10002'; // Ensure it's on top

            const box = document.createElement('div');
            box.className = 'wimpy-modal-box';
            Object.assign(box.style, {
                maxWidth: '90%',
                maxHeight: '90vh',
                width: 'auto',
                padding: '20px',
                display: 'flex',
                flexDirection: 'column'
            });

            box.innerHTML = `
                <h2 style="margin-top:0;"><i class="fas fa-eye"></i> Preview</h2>
                <div style="flex: 1; overflow: auto; margin-bottom: 15px; border: 2px solid #000; background: #eee; display: flex; justify-content: center; align-items: center; min-height: 200px;">
                    <img src="${dataUrl}" style="max-width: 100%; max-height: 60vh; object-fit: contain; display: block; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="wp-download-btn" class="sketch-btn" style="background: #000; color: #fff; width: auto; padding: 10px 20px;">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button onclick="document.getElementById('wp-preview-overlay').remove()" class="sketch-btn danger" style="width: auto; padding: 10px 20px;">
                        Close
                    </button>
                </div>
            `;

            overlay.appendChild(box);
            document.body.appendChild(overlay);

            document.getElementById('wp-download-btn').onclick = function () {
                const link = document.createElement('a');
                link.download = filename;
                link.href = dataUrl;
                link.click();

                // Success Toast
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerText = "Wallpaper Saved!";
                document.getElementById('toast-container').appendChild(toast);

                document.getElementById('wp-preview-overlay').remove();
            };
        }

        window.generateWallpaper = async function (width, height, bgStyle, e, customBgData = null) {
            const btn = e.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Drawing...';
            btn.disabled = true;

            // 1. Fetch Schedule Data (Monday to Saturday)
            // Use 'sb' or 'window.db' depending on what's available globally. 
            // In web2.html, 'sb' seems to be the variable for supabase client in this scope.
            const client = (typeof sb !== 'undefined') ? sb : (window.db || window.supabaseClient);

            // Helper for Time Formatting (Moved top level scope of func)
            const format12 = (t) => {
                if (!t) return '';
                const [hStr, mStr] = t.split(':');
                let h = parseInt(hStr, 10);
                const ampm = h >= 12 ? 'PM' : 'AM';
                h = h % 12;
                h = h ? h : 12;
                return `${h}:${mStr} ${ampm}`;
            };

            let scheduleData = [];
            if (client) {
                const { data, error } = await client.from('schedule').select('*').order('start_time', { ascending: true });
                if (!error && data) {
                    scheduleData = data;
                }
            }

            // Group by Day
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const grouped = {};
            days.forEach(d => grouped[d] = []);

            scheduleData.forEach(item => {
                if (grouped[item.day_of_week]) {
                    grouped[item.day_of_week].push(item);
                }
            });

            // 2. Create the Stage
            const stage = document.createElement('div');
            document.body.appendChild(stage);

            const isPortrait = height > width;

            // Apply Wimpy Styles to Stage
            let stageStyles = {
                width: width + 'px',
                height: height + 'px',
                position: 'fixed', top: '0', left: '-9999px', zIndex: '-9999',
                fontFamily: '"Patrick Hand", cursive',
                padding: '40px',
                boxSizing: 'border-box',
                display: 'flex', flexDirection: 'column', alignItems: 'center'
            };

            let tableColor = '#000';
            let titleColor = '#000';
            let footerColor = '#7f8c8d';

            if (bgStyle === 'paper') {
                stageStyles.backgroundColor = '#fdfbf7';
                stageStyles.backgroundImage = 'repeating-linear-gradient(#fdfbf7 0px, #fdfbf7 29px, #a4b0be 30px)';
            } else {
                // Glassmorphism Base and Theme Colors
                if (bgStyle === 'midnight') {
                    stageStyles.background = 'linear-gradient(to bottom, #0f2027, #203a43, #2c5364)';
                    titleColor = '#fff';
                    footerColor = 'rgba(255,255,255,0.7)';
                    tableColor = '#fff';
                } else if (bgStyle === 'sunset') {
                    stageStyles.background = 'linear-gradient(to right, #ff7e5f, #feb47b)';
                } else if (bgStyle === 'ocean') {
                    stageStyles.background = 'linear-gradient(to top, #30cfd0 0%, #330867 100%)';
                    titleColor = '#fff';
                    footerColor = 'rgba(255,255,255,0.7)';
                    tableColor = '#fff';
                } else if (bgStyle === 'forest') {
                    stageStyles.background = 'linear-gradient(135deg, #134e5e 0%, #71b280 100%)';
                    titleColor = '#fff';
                    footerColor = 'rgba(255,255,255,0.7)';
                    tableColor = '#fff';
                } else if (bgStyle === 'ipown') {
                    stageStyles.background = 'linear-gradient(to top, #09203f 0%, #537895 100%)'; // Dark blue gradient
                    stageStyles.fontFamily = '"Montserrat", sans-serif'; // Override font for ipown
                    titleColor = '#fff';
                    footerColor = 'rgba(255,255,255,0.9)';
                    tableColor = '#fff';
                } else if (bgStyle === 'custom' && customBgData) {
                    titleColor = '#fff';
                    footerColor = 'rgba(255,255,255,0.9)';
                    tableColor = '#fff';
                }
            }

            Object.assign(stage.style, { ...stageStyles });

            // Custom BG Image
            if (bgStyle === 'custom' && customBgData) {
                const bgImg = document.createElement('img');
                bgImg.src = customBgData;
                Object.assign(bgImg.style, {
                    position: 'absolute', top: '0', left: '0', width: '100%', height: '100%',
                    objectFit: 'cover', zIndex: '-1'
                });
                stage.appendChild(bgImg);
            }

            // Header (Only for non-ipown, as ipown has its own header)
            if (bgStyle !== 'ipown') {
                const title = document.createElement('h1');
                title.innerHTML = "CLASS SCHEDULE";
                Object.assign(title.style, {
                    fontFamily: '"Permanent Marker", cursive',
                    fontSize: isPortrait ? '5rem' : '6rem', // Huge font
                    marginBottom: '30px',
                    marginTop: '20px',
                    transform: 'rotate(-2deg)',
                    textShadow: '3px 3px 0px rgba(0,0,0,0.2)',
                    color: titleColor
                });
                stage.appendChild(title);
            }


            // 3. Build the Layout
            // Check if using the specific "Ipown" layout
            if (bgStyle === 'ipown') {
                // IPOWN FORMAT: Refined Wimpy + iPhone Layout
                const container = document.createElement('div');
                Object.assign(container.style, {
                    width: '100%',
                    height: '100%',
                    display: 'flex',
                    flexDirection: 'column',
                    justifyContent: 'flex-start',
                    padding: '20px',
                    paddingTop: '320px' // High top padding for Lock Screen transparency
                });

                // Title Area
                const headerBox = document.createElement('div');
                headerBox.style.textAlign = 'center';
                headerBox.style.marginBottom = '30px';

                const mainTitle = document.createElement('h1');
                mainTitle.innerText = "CLASS SCHEDULE";
                Object.assign(mainTitle.style, {
                    fontFamily: '"Permanent Marker", cursive',
                    fontSize: isPortrait ? '3.8rem' : '5rem', // Slightly toned down
                    color: '#000',
                    transform: 'rotate(-2deg)',
                    margin: '0',
                    textShadow: '2px 2px 0px rgba(0,0,0,0.1)'
                });
                headerBox.appendChild(mainTitle);

                const subTitle = document.createElement('h2');
                subTitle.innerText = "BSIT 2106";
                Object.assign(subTitle.style, {
                    fontFamily: '"Patrick Hand", cursive',
                    fontSize: isPortrait ? '2rem' : '2.5rem',
                    color: '#2d3436',
                    marginTop: '5px',
                    fontWeight: 'bold'
                });
                headerBox.appendChild(subTitle);
                container.appendChild(headerBox);

                // List Container
                const listContainer = document.createElement('div');
                Object.assign(listContainer.style, {
                    display: 'flex',
                    flexDirection: 'column',
                    // Use flex & justify to distribute, but allow huge gap at bottom if needed
                    flex: '1',
                    justifyContent: 'space-evenly',
                    width: isPortrait ? '92%' : '75%', // Tighter width
                    maxWidth: '1000px',
                    margin: '0 auto',
                    paddingBottom: '50px'
                });

                days.forEach(day => {
                    const dayClasses = grouped[day];
                    if (dayClasses.length === 0) return;

                    const row = document.createElement('div');
                    Object.assign(row.style, {
                        display: 'flex',
                        alignItems: 'stretch', // Stretch to equal height
                        background: '#fcfaf5', // Off-white paper color
                        border: '2px solid #000', // Thinner border
                        borderRadius: '20px 5px 15px 5px', // Less crazy radius
                        padding: '0', // Removing padding from container to let children handle it
                        overflow: 'hidden', // Contain children
                        color: '#000',
                        boxShadow: '4px 4px 0 rgba(0,0,0,0.15)',
                        transform: `rotate(${Math.random() * 1.5 - 0.75}deg)`, // More subtle rotation
                        marginBottom: '15px'
                    });

                    // Day Name (Left Side Column)
                    const dayLabel = document.createElement('div');
                    dayLabel.innerText = day.substr(0, 3).toUpperCase(); // Shorten to MON, TUE
                    Object.assign(dayLabel.style, {
                        fontFamily: '"Permanent Marker", cursive',
                        fontSize: isPortrait ? '2rem' : '2.5rem',
                        width: '60px', // Fixed small width
                        backgroundColor: '#000', // Black sidebar
                        color: '#fff',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        writingMode: 'vertical-lr', // Vertical text
                        transform: 'rotate(180deg)', // Fix orientation
                        textAlign: 'center',
                        borderRight: '2px solid #000'
                    });
                    row.appendChild(dayLabel);

                    // Classes List (Right Side)
                    const classListCtx = document.createElement('div');
                    Object.assign(classListCtx.style, {
                        flex: '1',
                        display: 'flex',
                        flexDirection: 'column',
                        padding: '15px 20px',
                        gap: '12px'
                    });

                    dayClasses.forEach(cls => {
                        const cRow = document.createElement('div');
                        Object.assign(cRow.style, {
                            display: 'flex',
                            flexDirection: 'row',
                            justifyContent: 'space-between',
                            alignItems: 'center', // Center vertically
                            fontFamily: '"Patrick Hand", cursive',
                            fontWeight: 'bold',
                            borderBottom: '1px dashed #ccc',
                            paddingBottom: '10px',
                            width: '100%'
                        });

                        // LEFT: Details
                        const leftCol = document.createElement('div');
                        Object.assign(leftCol.style, {
                            display: 'flex',
                            flexDirection: 'column',
                            flex: '1'
                        });

                        // Subject
                        const subjSpan = document.createElement('div');
                        subjSpan.innerText = cls.subject_name;
                        Object.assign(subjSpan.style, {
                            fontSize: isPortrait ? '1.4rem' : '1.6rem',
                            color: '#000',
                            lineHeight: '1.2'
                        });
                        leftCol.appendChild(subjSpan);

                        // Time & Prof
                        const tStart = format12(cls.start_time);
                        const tEnd = format12(cls.end_time);
                        const detailsSpan = document.createElement('div');
                        detailsSpan.innerHTML = `<span style="color:#c0392b">${tStart}-${tEnd}</span> &bull; <span style="color:#7f8c8d; font-weight:normal;">${cls.instructor || 'TBA'}</span>`;
                        detailsSpan.style.fontSize = isPortrait ? '1rem' : '1.2rem';
                        detailsSpan.style.marginTop = '2px';
                        leftCol.appendChild(detailsSpan);

                        cRow.appendChild(leftCol);

                        // RIGHT: Vertical Room Tag (Pill)
                        const roomNo = (cls.room || 'TBA').replace('RM', '').trim();
                        const roomTag = document.createElement('div');
                        Object.assign(roomTag.style, {
                            background: '#e74c3c',
                            color: '#fff',
                            borderRadius: '20px',
                            padding: '5px 8px',
                            display: 'flex',
                            flexDirection: 'column',
                            justifyContent: 'center',
                            alignItems: 'center',
                            marginLeft: '10px',
                            minWidth: '28px',
                            boxShadow: '1px 1px 0 rgba(0,0,0,0.2)',
                            border: '2px solid #000'
                        });

                        for (let char of roomNo) {
                            const s = document.createElement('span');
                            s.innerText = char;
                            s.style.lineHeight = '0.8';
                            s.style.fontSize = '0.9rem';
                            s.style.fontFamily = '"Permanent Marker", cursive';
                            roomTag.appendChild(s);
                        }

                        cRow.appendChild(roomTag);
                        classListCtx.appendChild(cRow);
                    });
                    row.appendChild(classListCtx);

                    listContainer.appendChild(row);
                });

                container.appendChild(listContainer);
                stage.appendChild(container);

            } else {
                // --- ORIGINAL GRID LAYOUT (Wimpy/Paper/Standard Glass) ---
                const gridContainer = document.createElement('div');
                Object.assign(gridContainer.style, {
                    display: 'flex',
                    flexWrap: 'nowrap', // Force single row if landscape
                    width: '100%',
                    height: '100%', // Fill available space
                    gap: '15px',
                    alignItems: 'stretch',
                    justifyContent: 'center'
                });

                // If portrait, might want 2 rows of 3
                if (isPortrait) {
                    gridContainer.style.flexWrap = 'wrap';
                }

                days.forEach((day, index) => {
                    const dayCol = document.createElement('div');
                    Object.assign(dayCol.style, {
                        flex: '1',
                        display: 'flex',
                        flexDirection: 'column',
                        border: (bgStyle === 'paper') ? '3px solid #000' : `2px solid ${tableColor}`,
                        borderRadius: '10px',
                        background: (bgStyle === 'paper') ? 'rgba(255,255,255,0.8)' : 'rgba(255,255,255,0.1)',
                        overflow: 'hidden',
                        backdropFilter: 'blur(5px)',
                        minWidth: isPortrait ? '45%' : '0' // In portrait, 2 cols per row
                    });

                    // Day Header
                    const header = document.createElement('div');
                    header.innerText = day.toUpperCase();
                    Object.assign(header.style, {
                        background: (bgStyle === 'paper') ? '#000' : 'rgba(0,0,0,0.5)',
                        color: '#fff',
                        textAlign: 'center',
                        fontFamily: '"Permanent Marker", cursive',
                        fontSize: '1.8rem',
                        padding: '10px 0'
                    });
                    dayCol.appendChild(header);

                    // Classes Container
                    const list = document.createElement('div');
                    Object.assign(list.style, {
                        flex: '1',
                        padding: '10px',
                        display: 'flex',
                        flexDirection: 'column',
                        gap: '10px'
                    });

                    const classes = grouped[day];
                    if (classes.length === 0) {
                        const emptyMsg = document.createElement('div');
                        emptyMsg.innerText = "REST DAY";
                        Object.assign(emptyMsg.style, {
                            textAlign: 'center',
                            color: (bgStyle === 'paper') ? '#bdc3c7' : 'rgba(255,255,255,0.5)',
                            marginTop: 'auto',
                            marginBottom: 'auto',
                            fontSize: '1.5rem',
                            fontWeight: 'bold',
                            transform: 'rotate(-5deg)'
                        });
                        list.appendChild(emptyMsg);
                    } else {
                        classes.forEach(cls => {
                            const item = document.createElement('div');

                            // Item Style wrapper
                            Object.assign(item.style, {
                                borderBottom: (bgStyle === 'paper') ? '2px dashed #000' : `1px dashed ${tableColor}`,
                                paddingBottom: '8px',
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'stretch'
                            });

                            // LEFT: Standard Info
                            const leftBox = document.createElement('div');
                            leftBox.style.flex = '1';

                            const tStart = format12(cls.start_time);
                            const tEnd = format12(cls.end_time);
                            // Dynamic Font Sizing for Mobile Optimization
                            const fontSizeTime = isPortrait ? '1.8rem' : '1.4rem';
                            const fontSizeSubj = isPortrait ? '1.5rem' : '1.2rem';
                            const fontSizeProf = isPortrait ? '1.3rem' : '1rem';

                            leftBox.innerHTML = `
                            <div style="font-weight:bold; font-size:${fontSizeTime}; color:${(bgStyle === 'paper' ? '#d63031' : '#ff7675')}">${tStart} - ${tEnd}</div>
                            <div style="font-size:${fontSizeSubj}; line-height:1.1; font-weight:bold; color:${tableColor}">${cls.subject_name}</div>
                            <div style="font-size:${fontSizeProf}; margin-top:5px; color:${(bgStyle === 'paper' ? '#2d3436' : footerColor)}">
                                <i class="fas fa-chalkboard-teacher"></i> ${cls.instructor || 'TBA'}
                            </div>
                        `;
                            item.appendChild(leftBox);

                            // RIGHT: Vertical Room Tag
                            const roomNo = (cls.room || 'TBA').replace('RM', '').trim();
                            const roomTag = document.createElement('div');
                            Object.assign(roomTag.style, {
                                background: '#e74c3c', // Red
                                color: '#fff',
                                borderRadius: '50px',
                                padding: '5px 8px',
                                display: 'flex',
                                flexDirection: 'column',
                                justifyContent: 'center',
                                alignItems: 'center',
                                marginLeft: '8px',
                                minWidth: '30px',
                                boxShadow: '2px 2px 0 rgba(0,0,0,0.2)',
                                border: (bgStyle === 'paper') ? '2px solid #000' : 'none'
                            });

                            // Stack characters
                            for (let char of roomNo) {
                                const s = document.createElement('span');
                                s.innerText = char;
                                s.style.lineHeight = '0.9';
                                s.style.fontSize = fontSizeSubj;
                                s.style.fontFamily = '"Permanent Marker", cursive';
                                roomTag.appendChild(s);
                            }
                            item.appendChild(roomTag);

                            list.appendChild(item);
                        });
                    }

                    dayCol.appendChild(list);
                    gridContainer.appendChild(dayCol);
                });

                stage.appendChild(gridContainer);
            }

            // Footer
            const footer = document.createElement('div');
            footer.innerText = "Generated by Sistema ni JV";
            Object.assign(footer.style, {
                marginTop: '20px', fontSize: '2rem', color: footerColor, fontFamily: (bgStyle === 'ipown' ? '"Montserrat", sans-serif' : '"Permanent Marker", cursive')
            });
            stage.appendChild(footer);

            // Capture
            try {
                const canvas = await html2canvas(stage, { scale: 1, useCORS: true, logging: false });
                const dataUrl = canvas.toDataURL('image/png');
                const filename = `WimpySchedule_${width}x${height}_${Date.now()}.png`;
                showWallpaperPreview(dataUrl, filename);
            } catch (err) {
                console.error(err);
                alert("Oops! Could not generate wallpaper.");
            } finally {
                setTimeout(() => stage.remove(), 2000);
                btn.innerHTML = originalText;
                btn.disabled = false;
                document.getElementById('wallpaperModal').classList.add('hidden');
            }
        }
    </script>

    <!-- GROUP CHAT MODAL -->
    <div id="groupChatModal" class="hidden">
        <div class="sketch-box"
            style="width: 100%; height: 100%; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: #fff; border: 3px solid #000;">
            <!-- Header -->
            <div
                style="padding: 10px; background: #6c5ce7; color: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #000;">
                <h3 style="margin: 0; font-size: 1.2rem;"><i class="fas fa-users"></i> Class Chismis</h3>
                <button onclick="window.groupChat.close()"
                    style="background: transparent; border: none; color: white; font-size: 1.2rem; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- History -->
            <div id="gc-history"
                style="flex: 1; overflow-y: auto; padding: 10px; background: #dfe6e9; display: flex; flex-direction: column; gap: 8px;">
                <!-- Messages go here -->
            </div>

            <!-- Input -->
            <div style="padding: 10px; border-top: 3px solid #000; background: #fff; display: flex; gap: 5px;">
                <input type="text" id="gc-input" placeholder="Say something..."
                    style="flex: 1; padding: 8px; border: 2px solid #000; font-family: 'Patrick Hand'; font-size: 1rem;">
                <button onclick="window.groupChat.send()"
                    style="background: #6c5ce7; color: white; border: 2px solid #000; padding: 0 15px; cursor: pointer;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Group Chat Script -->
    <script src="js/group-chat.js"></script>
</body>

</html>