<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ni JV</title>
    <!-- Supabase -->
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="logo.png">
    <!-- Open Graph / Social Media Sharing Image -->
    <meta property="og:image" content="logo.png">
    <meta name="twitter:image" content="logo.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
       (function(){
          emailjs.init("KtQgxJvMwR6IfuU3_");
       })();
    </script>
    <!-- html2canvas for Wallpaper Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Permanent+Marker&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        :root {
            --paper-color: #fdfbf7;
            --line-color: #a4b0be;
            --ink-color: #2f3542;
            --red-ink: #ff4757;
            --highlight: #ffee58;
            --tape-color: rgba(255, 255, 255, 0.4);
        }

        body {
            font-family: 'Patrick Hand', cursive;
            background-color: #57606f; /* Dark Desk Background */
            background-image: radial-gradient(#2f3542 15%, transparent 16%), radial-gradient(#2f3542 15%, transparent 16%);
            background-size: 20px 20px;
            margin: 0;
            padding: 20px;
            color: var(--ink-color);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- CUSTOM SCROLLBAR --- */
        ::-webkit-scrollbar {
            width: 14px;
        }
        ::-webkit-scrollbar-track {
            background: #fdfbf7; /* Paper color */
            border-left: 2px solid #000;
        }
        ::-webkit-scrollbar-thumb {
            background: #2f3542; /* Pencil lead color */
            border: 3px solid #fdfbf7; /* Creates a gap effect */
            border-radius: 10px;
            background-clip: padding-box;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #d63031; /* Red pen on hover */
            border: 3px solid #fdfbf7;
        }

        /* For Firefox */
        html {
            scrollbar-color: #2f3542 #fdfbf7; /* thumb and track color */
            scrollbar-width: thin;
        }


        /* --- THE BINDER CONTAINER --- */
        .binder {
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            background: var(--paper-color);
            box-shadow: 15px 15px 30px rgba(0,0,0,0.4);
            border-radius: 5px;
            position: relative;
            min-height: 85vh;
            overflow: hidden; /* For rounded corners */
            transition: max-width 0.3s ease;
        }
        .binder.wide-mode { max-width: 98%; }

        /* Left Sidebar (The Rings & Tabs) */
        .sidebar {
            width: 80px;
            background: #2f3542;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 40px;
            z-index: 20;
            flex-shrink: 0;
        }

        .binder-ring {
            width: 40px;
            height: 15px;
            background: linear-gradient(90deg, #bdc3c7, #fff, #bdc3c7);
            border-radius: 10px;
            margin-bottom: 60px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            position: relative;
            z-index: 25;
        }
        
        .binder-ring::before {
            content: '';
            position: absolute;
            left: -15px;
            top: 2px;
            width: 12px;
            height: 12px;
            background: #000;
            border-radius: 50%;
        }

        /* Navigation Tabs (Vertical Sticky Notes) */
        .nav-tabs {
            position: absolute;
            left: 60px; /* Moved left to hug the spine tighter */
            top: 50px;  /* Pushed down slightly for better spacing */
            display: flex;
            flex-direction: column;
            gap: 20px; /* Increased gap to prevent crowding */
            z-index: 15;
        }

        .tab-btn {
            width: 130px; /* Slightly narrower to reduce overlap chance */
            padding: 12px 10px 12px 25px;
            font-family: 'Permanent Marker', cursive;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            text-align: left;
            transition: transform 0.2s ease;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            clip-path: polygon(0% 0%, 95% 0%, 100% 50%, 95% 100%, 0% 100%);
            position: relative;
        }

        .tab-btn:hover { transform: translateX(10px); }
        .tab-btn.active { transform: translateX(15px); box-shadow: 5px 5px 10px rgba(0,0,0,0.1); }

        /* Tab Colors */
        .tab-btn:nth-child(1) { background: #ff7675; color: white; transform: rotate(-2deg); } /* Schedule */
        .tab-btn:nth-child(2) { background: #74b9ff; color: white; transform: rotate(1deg); } /* Assignments */
        .tab-btn:nth-child(3) { background: #55efc4; color: #2d3436; transform: rotate(-1deg); } /* Calendar */
        .tab-btn:nth-child(4) { background: #ffeaa7; color: #2d3436; transform: rotate(2deg); } /* Links */
        .tab-btn:nth-child(5) { background: #a29bfe; color: #2d3436; transform: rotate(-1deg); } /* Help */

        /* --- MAIN PAPER AREA --- */
        .paper-content {
            flex-grow: 1;
            /* INCREASED LEFT PADDING from 120px to 170px to clear the tabs */
            padding: 40px 40px 40px 170px; 
            background-image: repeating-linear-gradient(var(--paper-color) 0px, var(--paper-color) 29px, var(--line-color) 30px);
            position: relative;
        }

        /* The Vertical Red Margin Line */
        .paper-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 145px; /* Moved margin line to match new padding */
            width: 2px;
            height: 100%;
            background-color: #ff9ff3;
            opacity: 0.6;
            z-index: 0;
        }

        /* --- TYPOGRAPHY --- */
        h1 {
            font-family: 'Permanent Marker', cursive;
            font-size: 3rem;
            margin: 0;
            transform: rotate(-2deg);
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        /* --- NEW WIMPY ANIMATIONS --- */
        @keyframes paperDeal {
            0% { opacity: 0; transform: translateY(50px) rotate(-5deg) scale(0.9); }
            100% { opacity: 1; transform: translateY(0) rotate(0deg) scale(1); }
        }

        @keyframes buttonWiggle {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(-3deg); }
            50% { transform: rotate(3deg); }
            75% { transform: rotate(-1deg); }
            100% { transform: rotate(0deg); }
        }

        /* Scribble effect for headers on hover */
        h2:hover {
            animation: buttonWiggle 0.5s ease-in-out infinite;
        }

        /* --- CARDS & ITEMS --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 30px;
            position: relative;
            z-index: 5;
        }

        .class-card {
            background: white;
            padding: 20px;
            box-shadow: 3px 3px 8px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
            border: 1px solid #d1ccc0;
            /* Default hidden for animation */
            opacity: 0; 
            animation: paperDeal 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Tape Effect on top of cards */
        .class-card::before {
            content: '';
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 30px;
            background-color: rgba(255,255,255,0.4);
            border-left: 1px dashed rgba(0,0,0,0.1);
            border-right: 1px dashed rgba(0,0,0,0.1);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            opacity: 0.7;
        }

        .class-card:hover {
            transform: scale(1.02) rotate(-1deg);
            box-shadow: 10px 10px 15px rgba(0,0,0,0.15);
            z-index: 10;
        }

        /* Specific Styles for Assignment Cards (Sticky Note Look) */
        #assignment-list .class-card {
            background: #fffa65;
            border: none;
            border-bottom-right-radius: 40px 5px;
        }
        #assignment-list .class-card::after {
            content: '';
            position: absolute;
            bottom: 0; right: 0;
            width: 0; height: 0;
            border-style: solid;
            border-width: 0 0 40px 40px;
            border-color: transparent transparent rgba(0,0,0,0.1) transparent;
        }

        .subject-code {
            font-family: 'Permanent Marker', cursive;
            font-size: 1.5rem;
            color: #d63031;
        }

        .time-badge {
            float: right;
            font-weight: bold;
            background: #000;
            color: #fff;
            padding: 2px 8px;
            font-size: 0.9rem;
            border-radius: 3px;
        }

        /* --- BUTTONS --- */
        .filter-bar {
            margin: 20px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .sketch-btn {
            background: transparent;
            border: 2px solid var(--ink-color);
            padding: 8px 16px;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            transition: 0.2s;
            text-decoration: none;
            color: var(--ink-color);
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .sketch-btn:hover {
            background: var(--ink-color);
            color: white;
            transform: rotate(-2deg);
            animation: buttonWiggle 0.4s ease-in-out;
        }

        .sketch-btn.meet { border-color: #0984e3; color: #0984e3; }
        .sketch-btn.meet:hover { background: #0984e3; color: white; }
        
        .sketch-btn.classroom { border-color: #00b894; color: #00b894; }
        .sketch-btn.classroom:hover { background: #00b894; color: white; }

        .sketch-btn.danger {
            border-color: #d63031;
            color: #d63031;
            font-size: 0.9rem;
        }
        .sketch-btn.danger:hover { background: #d63031; color: white; }

        /* Wallpaper Button Custom Style */
        .wallpaper-btn { margin-left: auto; border-color: #6c5ce7; color: #6c5ce7; }
        .wallpaper-btn:hover { background: #6c5ce7; color: white; }

        /* --- ADMIN FORMS --- */
        .admin-controls {
            display: none; /* Hidden by default */
            margin-top: 40px;
            background: #fff;
            padding: 20px;
            border: 2px dashed #000;
            position: relative;
        }
        .admin-controls::before {
            content: 'ADMIN ONLY';
            position: absolute;
            top: -15px;
            left: 20px;
            background: #d63031;
            color: white;
            padding: 2px 10px;
            font-weight: bold;
            transform: rotate(-2deg);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            border-bottom: 2px solid #ccc;
            background: transparent;
            font-family: 'Patrick Hand';
            font-size: 1.2rem;
            box-sizing: border-box;
        }
        input:focus, textarea:focus {
            outline: none;
            border-bottom: 2px solid var(--ink-color);
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .loader { font-size: 1.5rem; text-align: center; margin-top: 50px; color: #7f8c8d; }

        /* --- FLOATING UP BUTTON (Wimpy Style) --- */
        /* --- Better Loading States (Doodle Animation) --- */
        .loader {
            font-family: 'Permanent Marker', cursive;
            font-size: 1.5rem;
            text-align: center;
            margin-top: 50px;
            color: #555;
            animation: pencilFloat 1s ease-in-out infinite alternate;
        }

        .loader::before {
            content: '\f303'; /* Pencil Icon */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            margin-right: 5px;
        }

        @keyframes pencilFloat {
            from { transform: translateY(0) rotate(-5deg); }
            to { transform: translateY(-10px) rotate(5deg); }
        }

        /* --- LIVE CLASS CARD STYLES --- */
        .live-card {
            padding: 15px 20px;
            border-radius: 4px;
            position: relative;
            box-shadow: 0 0 15px rgba(214, 48, 49, 0.3);
            transform: rotate(-1deg);
            animation: urgentPulse 2s infinite;
        }

        .live-card::before {
            content: 'HAPPENING NOW';
            position: absolute;
            top: -12px;
            left: 20px;
            background: #d63031;
            color: white;
            font-family: 'Permanent Marker', cursive;
            padding: 2px 10px;
            font-size: 1rem;
            transform: rotate(-2deg);
            z-index: 2;
        }

        .live-card h3 {
            margin: 10px 0 5px 0;
            color: #d63031;
            font-size: 1.8rem;
        }

        .live-card-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        @keyframes urgentPulse {
            0% { box-shadow: 0 0 0 0 rgba(214, 48, 49, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(214, 48, 49, 0); }
            100% { box-shadow: 0 0 0 0 rgba(214, 48, 49, 0); }
        }

        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #fff; /* Paper white */
            border: 3px solid #000; /* Marker pen black */
            /* This creates a non-perfect, hand-drawn circle shape */
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; 
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 5px 5px 0px rgba(0,0,0,0.2); /* Hard shadow for pop */
            transition: transform 0.2s ease;
            z-index: 100;
            color: #000;
            font-size: 1.8rem;
        }

        .floating-action:hover {
            transform: translateY(-5px) rotate(-10deg); /* Floats and tilts when hovered */
            box-shadow: 8px 8px 0px rgba(0,0,0,0.2);
            background: #000; /* Invert colors on hover */
            color: #fff;
            border-color: #fff;
        }

        /* --- TOAST NOTIFICATIONS --- */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10001; /* Ensure above modals */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #fff740; /* Sticky Note Yellow */
            color: #000;
            padding: 15px 25px;
            border: 2px solid #000;
            font-family: 'Patrick Hand', cursive;
            font-size: 1.2rem;
            box-shadow: 5px 5px 0 rgba(0,0,0,0.2);
            transform: rotate(-2deg); /* Wimpy Style Tilt */
            opacity: 0;
            animation: slideInFadeOut 4s forwards; /* Lasts 4 seconds total */
            min-width: 200px;
            text-align: center;
        }

        /* Animation: Slide in -> Wait -> Fade Up & Out */
        @keyframes slideInFadeOut {
            0% { transform: translateX(100%) rotate(0deg); opacity: 0; }
            10% { transform: translateX(0) rotate(-2deg); opacity: 1; }
            80% { transform: translateX(0) rotate(-2deg); opacity: 1; }
            100% { transform: translateY(-20px) rotate(-2deg); opacity: 0; }
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            body { padding: 10px; background-size: 15px 15px; }
            .binder { flex-direction: column; min-height: 100vh; border-radius: 0; margin: 0 -10px; width: calc(100% + 20px); }
            .sidebar { 
                width: 100%; 
                height: auto; 
                flex-direction: row; 
                justify-content: center; 
                padding: 10px 0; 
                align-items: center; 
                background: #2f3542;
            }
            .binder-ring { 
                display: none; /* Hide rings on mobile to save space */
            }
            .nav-tabs {
                position: static;
                flex-direction: row;
                gap: 10px;
                padding: 10px 15px;
                overflow-x: auto;
                width: 100%;
                box-sizing: border-box;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Firefox */
            }
            .nav-tabs::-webkit-scrollbar { display: none; } /* Chrome/Safari */

            .tab-btn {
                width: auto;
                padding: 10px 20px;
                font-size: 1rem;
                clip-path: none;
                border-radius: 5px;
                flex-shrink: 0;
                margin-bottom: 0;
                box-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            }
            .paper-content {
                padding: 20px 15px;
                background-size: 100% 30px; /* Adjust line height */
            }
            .paper-content::before { display: none; /* Remove margin line on mobile */ }
            
            h1 { font-size: 2rem; }
            .casio-watch { position: relative; top: 0; right: 0; display: inline-block; margin: 10px auto; transform: rotate(0); }
            .grid-container { grid-template-columns: 1fr; gap: 20px; }

            /* Better touch targets */
            .sketch-btn {
                padding: 10px 20px;
                font-size: 1.1rem;
                width: 100%;
                justify-content: center;
                box-sizing: border-box;
            }
            
            .filter-bar {
                justify-content: center;
            }
            
            .filter-bar .sketch-btn {
                width: auto;
                flex: 1 1 auto;
            }

            /* Prevent iOS zoom on inputs */
            input, select, textarea {
                font-size: 16px !important; 
            }

            /* Fix Wallpaper Button Visibility on Mobile */
            .wallpaper-btn { margin-left: 0; width: 100%; margin-top: 5px; }

            /* Center Toasts on Mobile */
            #toast-container {
                left: 50%;
                transform: translateX(-50%);
                right: auto;
                width: 90%;
                align-items: center;
            }

            /* Fix Active Users List on Mobile (Horizontal) */
            #active-users-list {
                flex-direction: row !important;
                flex-wrap: wrap;
                justify-content: center;
            }
            #active-users-panel {
                padding-bottom: 0 !important;
                margin-top: 0 !important;
            }
        }

        /* --- WIMPY POP-UP MODAL --- */
        .wimpy-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10000;
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
        }
        .wimpy-modal-box {
            background: #fff; border: 3px solid #000;
            border-radius: 2% 6% 5% 4% / 1% 1% 2% 4%;
            padding: 30px; width: 90%; max-width: 400px;
            text-align: center; box-shadow: 10px 10px 0 rgba(0,0,0,0.2);
            transform: rotate(-1deg);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8) rotate(-5deg); opacity: 0; } to { transform: scale(1) rotate(-1deg); opacity: 1; } }
    </style>
    <style>
        .sticky-time {
            position: relative;
            margin: 0 auto 20px auto;
            background: #fff740; /* Post-it yellow */            
            padding: 10px 15px; /* Keep padding */
            width: 240px; /* Increased width to accommodate larger text */
            text-align: center;
            box-shadow: 4px 4px 5px rgba(0,0,0,0.2);
            transform: rotate(3deg); /* Taped crookedly */
            font-family: 'Permanent Marker', cursive;
            z-index: 10;
            border-bottom-right-radius: 30px 5px; /* Dog-ear effect */            
        }

        .sticky-time .pin {
            position: absolute;
            top: -15px;            
            left: 50%; /* Center the pin */
            font-size: 1.5rem;
            filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.2));            
            transform: translateX(-50%); /* Adjust for centering */
        }

        .sticky-time small {
            display: block;
            font-size: 1rem; /* Slightly larger for better readability */
            color: #555;            
            font-family: 'Patrick Hand', cursive;            
            margin-bottom: 5px;            
        }

        .sticky-time #live-clock {
            font-size: 3rem; /* Significantly larger font size */
            color: #000;            
            line-height: 1;            
        }

        /* Mobile */
        @media (max-width: 768px) {
            .sticky-time {
                margin: 20px auto;                
                transform: rotate(0deg);                
                width: 150px; /* Smaller width for mobile */
                padding: 8px 10px; /* Adjusted padding for mobile */
            }
            .sticky-time small {
                font-size: 0.9rem; /* Smaller font for mobile */
            }
            .sticky-time #live-clock {
                font-size: 2.2rem; /* Smaller font for mobile */
            }
            .sticky-time .pin {
                left: 50%; /* Ensure pin remains centered */
                transform: translateX(-50%);
            }
        }

        /* --- LIVE ACTIVE USERS STYLES --- */
        .live-user-bubble {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid #fff;
            position: relative;
            cursor: pointer;
            transition: transform 0.2s;
            background-color: #fff; /* Fallback */
        }

        .live-user-bubble:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .live-user-bubble img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* The Green Dot */
        .live-user-bubble::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background-color: #2ecc71; /* Green */
            border: 2px solid #2f3542; /* Dark border to match theme */
            border-radius: 50%;
        }

        /* Tooltip for the name */
        .live-user-bubble:hover::before {
            content: attr(data-name);
            position: absolute;
            left: 60px; /* Push to the right of the sidebar */
            top: 50%;
            transform: translateY(-50%);
            background: #000;
            color: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: 'Patrick Hand';
            white-space: nowrap;
            z-index: 20;
            font-size: 1rem;
        }
    </style>
</head>
<body>

    <div class="binder">
        <!-- The Spine / Sidebar -->
        <div class="sidebar">
            <div class="binder-ring"></div>
            <div class="binder-ring"></div>
            <div class="binder-ring"></div>

            <!-- START: Live Active Users -->
            <div id="active-users-panel" style="margin-top: auto; padding-bottom: 20px; text-align: center; width: 100%;">
                <p style="color: #fff; font-family: 'Patrick Hand'; font-size: 0.9rem; margin-bottom: 10px; border-bottom: 1px dashed #7f8c8d; padding-bottom: 5px;">
                    <i class="fas fa-eye"></i> IN THE ROOM:
                </p>
                <div id="active-users-list" style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <!-- Avatars will appear here dynamically -->
                    <small style="color: #bdc3c7;">Scanning...</small>
                </div>
            </div>
            <!-- END: Live Active Users -->
        </div>

        <!-- The Tabs -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('schedule', event)">Schedule</button>
            <button class="tab-btn" onclick="switchTab('assignments', event)">Homework</button>
            <button class="tab-btn" onclick="switchTab('calendar', event)">Events</button>
            <button class="tab-btn" onclick="switchTab('links', event)">Links</button>
            <button class="tab-btn" onclick="switchTab('help', event)">Help Guide</button>
            <button class="tab-btn admin-only hidden" onclick="switchTab('admin-tools', event)" style="background: #2d3436; color: #fff; transform: rotate(-2deg);">Admin Tools</button>
        </div>

        <!-- The Main Paper Content -->
        <div class="paper-content">
            
            <div style="display: flex; justify-content: center; align-items: flex-start; flex-wrap: wrap;">
                <div class="sticky-time">
                    <span class="pin"><i class="fas fa-thumbtack"></i></span>
                    <small>TIME CHECK:</small>
                    <div id="live-clock">00:00</div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
                <!-- User Info (Avatar + Welcome Message) -->
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img id="userAvatarDisplay" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #000; cursor: pointer; object-fit: cover;" title="Click to change profile picture">
                    <div>
                        <p id="welcome-msg" style="background: yellow; display: inline-block; transform: rotate(-1deg); padding: 0 5px; margin: 0;">Loading User...</p>
                        <div onclick="editUserStatus()" style="cursor: pointer; margin-top: 5px; transform: rotate(1deg);" title="Click to edit status">
                            <small style="font-family: 'Patrick Hand'; color: #2f3542; border-bottom: 1px dashed #a4b0be;"><span id="user-status-text">Certified Member</span> <i class="fas fa-pencil-alt" style="font-size: 0.8rem;"></i></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DYNAMIC LIVE CLASS SECTION -->
            <div id="live-class-container" style="display: none; margin-bottom: 20px;">
                <!-- JavaScript will inject the card here -->
            </div>

            <!-- Logout Button (Hidden in plain sight as a doodle button) -->
            <div style="margin-top: 10px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                <button onclick="toggleWideMode()" class="sketch-btn" style="border: none; text-decoration: underline;" title="Stretch View">
                    <i class="fas fa-expand-arrows-alt"></i> Wide View
                </button>
                <button onclick="window.location.href='index.html'" class="sketch-btn admin-only hidden" style="border: none; text-decoration: underline; color: #636e72;">
                    <i class="fas fa-undo"></i> Admin Menu
                </button>
                <button onclick="logout()" class="sketch-btn danger" style="border: none; text-decoration: underline;">
                    <i class="fas fa-door-open"></i> Go Home
                </button>
            </div>

            <br>

            <!-- ================= ADMIN TOOLS TAB (NEW SECTION) ================= -->
            <div id="admin-tools" class="tab-content hidden">
                <h2><i class="fas fa-user-shield"></i> Admin Control Panel</h2>
                
                <div class="grid-container" style="grid-template-columns: 1fr;">
                    <!-- Moved Forms -->
                    <div class="admin-controls" id="admin-schedule-form" style="display: block;">
                        <h3>Admin's Note: Add Class</h3>
                        <form onsubmit="addClass(event)" autocomplete="off">
                            <select id="s-day" required>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                            </select>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="text" id="s-code" placeholder="Code (IT 211)" required>
                                <input type="text" id="s-name" placeholder="Subject Name" required>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <input type="time" id="s-start" required>
                                <input type="time" id="s-end" required>
                            </div>
                            <input type="text" id="s-room" placeholder="Room / Lab">
                            <input type="text" id="s-instructor" placeholder="Instructor">
                            <input type="url" id="s-meet" placeholder="G-Meet Link">
                            <input type="url" id="s-class" placeholder="Classroom Link">
                            <button type="submit" class="sketch-btn" style="background: #000; color: #fff;">Save to Schedule</button>
                        </form>
                    </div>

                    <div class="admin-controls" id="admin-assignment-form" style="display: block;">
                        <h3>Admin's Note: Add Homework</h3>
                        <form onsubmit="addAssignment(event)" autocomplete="off">
                            <input type="text" id="a-title" placeholder="Title" required>
                            <input type="text" id="a-subject" placeholder="Subject (e.g. Math)" required>
                            <input type="datetime-local" id="a-due">
                            <textarea id="a-desc" placeholder="Details..."></textarea>
                            <button type="submit" class="sketch-btn" style="background: #000; color: #fff;">Post Homework</button>
                        </form>
                    </div>

                    <div class="admin-controls" id="admin-event-form" style="display: block;">
                        <h3>Admin's Note: Add Event</h3>
                        <form onsubmit="addEvent(event)" autocomplete="off">
                            <input type="text" id="e-title" placeholder="Event Name" required>
                            <input type="date" id="e-date" required>
                            <input type="text" id="e-desc" placeholder="Description">
                            <button type="submit" class="sketch-btn" style="background: #000; color: #fff;">Save Event</button>
                        </form>
                    </div>

                    <div class="admin-controls" id="admin-file-form" style="display: block;">
                        <h3>Admin's Note: Upload Resource</h3>
                        <form onsubmit="uploadFile(event)" autocomplete="off">
                            <input type="text" id="f-title" placeholder="File Title (e.g. Week 1 Reviewer)" required>
                            
                            <!-- Subject Selection (Empty - JS will fill this) -->
                            <select id="f-subject" required style="margin-bottom: 10px;">
                                <option value="" disabled selected>Select Subject</option>
                                <option value="General">General / Other</option>
                                <!-- JavaScript will add your Schedule subjects here -->
                            </select>

                            <input type="file" id="f-file" required accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.jpg,.png,.jpeg">
                            <button type="submit" class="sketch-btn" id="upload-btn" style="background: #000; color: #fff;">
                                <i class="fas fa-paperclip"></i> Upload to Cabinet
                            </button>
                        </form>
                    </div>

                    <div class="admin-controls" id="admin-email-form" style="display: block;">
                        <h3>Admin's Note: Email Center <i class="fas fa-envelope"></i></h3>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">(Select a specific student or blast everyone)</p>
                        
                        <form onsubmit="sendEmailService(event)" autocomplete="off">
                            <!-- NEW: Recipient Dropdown -->
                            <select id="email-recipient" style="width: 100%; padding: 10px; margin-bottom: 10px; border: none; border-bottom: 2px solid #333; font-family: 'Patrick Hand'; font-size: 1.2rem; background: transparent;">
                                <option value="ALL">Send to Everyone (Blast)</option>
                                <!-- JavaScript will load student names here -->
                            </select>

                            <input type="text" id="email-subject" placeholder="Subject (e.g. You passed!)" required>
                            <textarea id="email-body" placeholder="Write your message here..." style="height: 100px;"></textarea>
                            
                            <button type="submit" class="sketch-btn" style="background: #000; color: #fff;">
                                <i class="fas fa-paper-plane"></i> Send Email
                            </button>
                        </form>
                    </div>

                    <!-- NEW: Gallery Manager for Landing Page -->
                    <div class="admin-controls" id="admin-gallery-form" style="display: block;">
                        <h3>Admin's Note: Landing Page Gallery <i class="fas fa-images"></i></h3>
                        <p style="font-size: 0.9rem; margin-bottom: 10px;">(Upload photos for the main login page)</p>
                        
                        <form onsubmit="uploadGalleryItem(event)" autocomplete="off">
                            <input type="text" id="g-caption" placeholder="Caption (e.g. First Day of School)" required>
                            <input type="file" id="g-file" required accept="image/*">
                            
                            <button type="submit" id="upload-gallery-btn" class="sketch-btn" style="background: #000; color: #fff;">
                                <i class="fas fa-camera"></i> Post to Gallery
                            </button>
                        </form>

                        <hr style="border: 1px dashed #ccc; margin: 15px 0;">
                        <div id="admin-gallery-list" style="max-height: 150px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- ================= SCHEDULE TAB ================= -->
            <div id="schedule" class="tab-content">
                <h2><i class="fas fa-clock"></i> Class Schedule</h2>
                
                <div class="filter-bar">
                    <button class="sketch-btn" onclick="filterSchedule('Monday')">Monday</button>
                    <button class="sketch-btn" onclick="filterSchedule('Tuesday')">Tuesday</button>
                    <button class="sketch-btn" onclick="filterSchedule('Wednesday')">Wednesday</button>
                    <button class="sketch-btn" onclick="filterSchedule('Thursday')">Thursday</button>
                    <button class="sketch-btn" onclick="filterSchedule('Friday')">Friday</button>
                    <button class="sketch-btn" onclick="filterSchedule('All')">All</button>
                    <button class="sketch-btn wallpaper-btn" onclick="openWallpaperModal()">
                        <i class="fas fa-camera-retro"></i> Wallpaper
                    </button>
                </div>
                
                <h3 id="current-day-label" style="text-align: center; font-size: 1.5rem; color: #57606f;">Weekly View</h3>

                <div id="schedule-list" class="grid-container">
                    <div class="loader">Flipping pages...</div>
                </div>
            </div>

            <!-- ================= ASSIGNMENTS TAB ================= -->
            <div id="assignments" class="tab-content hidden">
                <h2><i class="fas fa-thumbtack"></i> Assignments</h2>
                <div id="assignment-list" class="grid-container">
                    <div class="loader">Checking backpack...</div>
                </div>
            </div>

            <!-- ================= CALENDAR TAB ================= -->
            <div id="calendar" class="tab-content hidden">
                <h2><i class="fas fa-calendar-alt"></i> Upcoming Events</h2>
                <div id="events-list" class="grid-container">
                    <div class="loader">Looking at the wall calendar...</div>
                </div>
            </div>

            <!-- ================= LINKS & FILES TAB ================= -->
            <div id="links" class="tab-content hidden">
                <h2><i class="fas fa-folder-open"></i> Subject Reviewers</h2>

                <!-- Insert above <h3 id="file-filter-label"> -->
                <div style="position: relative; margin-bottom: 15px;">
                    <input type="text" id="file-search" placeholder="ðŸ” Search filename..." onkeyup="searchFiles()" 
                           style="border: 2px solid #000; border-radius: 20px; padding: 8px 15px; background: #fff;">
                </div>

                <!-- Subject Filter Bar (Empty - JS will fill this) -->
                <div class="filter-bar" id="link-filters" style="margin-bottom: 25px;">
                    <!-- JavaScript will automatically put buttons here based on your Schedule -->
                    <button class="sketch-btn" onclick="filterFiles('All')">All</button>
                    <button class="sketch-btn" onclick="filterFiles('General')">General</button>
                </div>

                <!-- The Dynamic File List -->
                <div style="margin-bottom: 30px; min-height: 200px;">
                    <h3 id="file-filter-label" style="color: #666; font-size: 1.2rem;">Showing: All Files</h3>
                    <div id="file-list" class="grid-container">
                        <div class="loader">Opening filing cabinet...</div>
                    </div>
                </div>
                <hr style="border: 2px dashed #a4b0be; margin: 30px 0;">
                <!-- Static Links -->
                <h3><i class="fas fa-external-link-alt"></i> External Tools</h3>
                <div class="grid-container">
                    <a href="https://drive.google.com/drive/folders/1n50vswAbnj1KnoxB0Obp3_vcrouz10CW?usp=drive_link" target="_blank" class="class-card" style="text-decoration: none; color: inherit; text-align: center; border: 2px dashed #00b894;">
                        <i class="fab fa-google-drive" style="font-size: 3rem; color: #00b894;"></i>
                        <h3 style="margin-top: 10px;">Old Archive</h3>
                    </a>
                    
                    <div onclick="openRequestModal()" class="class-card" style="cursor: pointer; text-align: center; border: 2px dashed #0984e3;">
                        <i class="fas fa-user-secret" style="font-size: 3rem; color: #0984e3;"></i>
                        <h3 style="margin-top: 10px;">Secret Request</h3>
                    </div>
                </div>


            </div>

            <!-- ================= HELP TAB ================= -->
            <div id="help" class="tab-content hidden">
                <h2><i class="fas fa-question-circle"></i> Student's Guide</h2>
                
                <div class="grid-container">
                    <div class="class-card" style="transform: rotate(1deg);">
                        <h3><i class="fas fa-book"></i> The Binder</h3>
                        <p>Welcome to your digital binder! Use the <b>colored tabs</b> on the left to navigate between your Schedule, Homework, and Reviewers.</p>
                    </div>
                    <div class="class-card" style="transform: rotate(-1deg);">
                        <h3><i class="fas fa-folder-open"></i> Reviewers & Files</h3>
                        <p>Go to the <b>"Links"</b> tab to find downloadable files. You can preview them before downloading! Use the search bar to find specific subjects.</p>
                    </div>
                    <div class="class-card" style="transform: rotate(1deg);">
                        <h3><i class="fas fa-camera-retro"></i> Memories</h3>
                        <p>Check out the login page for our class photo gallery. If you have photos to add, send them to the Admin via the "Secret Request" box!</p>
                    </div>
                    <div class="class-card" style="transform: rotate(-1deg);">
                        <h3><i class="fas fa-user-secret"></i> Secret Requests</h3>
                        <p>Found a bug? Want to suggest a feature? Use the <b>"Secret Request"</b> card in the Links tab to send an anonymous note to the admin.</p>
                    </div>
                </div>
            </div>

        </div> <!-- End Paper Content -->
    </div> <!-- End Binder -->

    <!-- Hand-drawn Up Arrow -->
    <div class="floating-action" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
        <i class="fas fa-arrow-up" style="filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.1));"></i>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Request Modal -->
    <div id="requestModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box" style="text-align: left;">
            <h2 style="margin-top:0;">Drop a Note</h2>
            <p>Got a request or a secret question for the admin?</p>
            <textarea id="req-content" placeholder="Type here..." style="width:100%; height:100px; font-family:'Patrick Hand'; font-size:1.2rem; padding:10px; border:2px solid #000;"></textarea>
            <div style="margin-top:10px; display:flex; gap:10px;">
                <button onclick="closeRequestModal()" class="sketch-btn">Cancel</button>
                <button onclick="submitRequest()" class="sketch-btn" style="background:#000; color:#fff;">Send</button>
            </div>
        </div>
    </div>

    <!-- Wallpaper Generator Modal -->
    <div id="wallpaperModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box">
            <h2><i class="fas fa-camera-retro"></i> Get Wallpaper</h2>
            <p>Select your device size:</p>
            <select id="wp-size-select" style="margin-bottom: 20px; font-family: 'Patrick Hand'; font-size: 1.2rem; padding: 10px; border: 2px solid #000; background: #fff; width: 100%;">
                <option value="auto">Current Screen (Adaptive)</option>
                <option value="1080,1920">Standard Phone (9:16)</option>
                <option value="1170,2532">Tall Phone / iPhone (19.5:9)</option>
                <option value="1290,2796">Max / Ultra Phone</option>
                <option value="1536,2048">Tablet / iPad (Portrait)</option>
                <option value="1920,1080">Desktop / Laptop (16:9)</option>
            </select>
            <p>Select Background Style:</p>
            <select id="wp-bg-select" onchange="toggleCustomBgInput(this)" style="margin-bottom: 20px; font-family: 'Patrick Hand'; font-size: 1.2rem; padding: 10px; border: 2px solid #000; background: #fff; width: 100%;">
                <option value="paper">Classic Paper (Wimpy Style)</option>
                <option value="midnight">Midnight Glass</option>
                <option value="sunset">Sunset Glass</option>
                <option value="ocean">Ocean Glass</option>
                <option value="forest">Forest Glass</option>
                <option value="custom">Custom Image (Upload)</option>
            </select>
            <input type="file" id="wp-custom-bg" accept="image/*" class="hidden" style="margin-bottom: 20px; font-family: 'Patrick Hand'; font-size: 1rem; width: 100%; border: 2px dashed #000; padding: 10px;">
            <button onclick="generateWallpaperFromSelect(event)" class="sketch-btn" style="background:#000; color:#fff; margin-bottom:10px; width:100%; justify-content:center;">
                <i class="fas fa-magic"></i> Generate Wallpaper
            </button>
            <button onclick="document.getElementById('wallpaperModal').classList.add('hidden')" class="sketch-btn danger">Cancel</button>
        </div>
    </div>

    <!-- Status Edit Modal -->
    <div id="statusModal" class="wimpy-modal-overlay hidden">
        <div class="wimpy-modal-box">
            <h2><i class="fas fa-id-badge"></i> Edit Status</h2>
            <p>How are you feeling today?</p>
            <input type="text" id="statusInput" placeholder="e.g. Certified Member" maxlength="20" style="margin-bottom: 20px; font-family: 'Patrick Hand'; font-size: 1.2rem; padding: 10px; border: 2px solid #000; background: #fff; width: 100%; text-align: center; box-sizing: border-box;">
            <button onclick="saveUserStatus()" class="sketch-btn" style="background:#000; color:#fff; margin-bottom:10px; width:100%; justify-content:center;">
                <i class="fas fa-save"></i> Save Status
            </button>
            <button onclick="document.getElementById('statusModal').classList.add('hidden')" class="sketch-btn danger">Cancel</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="dashboard.js"></script>

    <!-- PREVIEWER FEATURE & FILE LOGIC (Added Inline) -->
    <script>
        // --- CONFIGURATION (Matches script.js) ---
        const SB_URL = 'https://egnyblflgppsosunnilq.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnbnlibGZsZ3Bwc29zdW5uaWxxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0OTYzMjksImV4cCI6MjA4MjA3MjMyOX0.HR9lt4oHuFjGcjwsF_fLoJMuG2OI8aCIoRCSyyu0zVE';
        
        // Use existing client if available, else create
        const sb = window.db || supabase.createClient(SB_URL, SB_KEY);
        let globalFiles = [];

        // --- 1. PREVIEW MODAL ---
        window.openFilePreview = function(url, title) {
            if (!url) return alert('No file link available.');
            const existing = document.getElementById('filePreviewModal');
            if (existing) existing.remove();

            const isPdf = url.toLowerCase().includes('.pdf');
            const isImg = url.match(/\.(jpeg|jpg|gif|png|webp)$/i);
            
            const loaderHtml = `
                <div id="previewLoader" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#555;">
                    <i class="fas fa-spinner fa-spin" style="font-size:3rem;"></i>
                    <p style="font-family:'Patrick Hand'; font-size:1.5rem; margin-top:10px;">Unfolding paper...</p>
                </div>
            `;

            let contentHtml = '';

            if (isPdf) {
                contentHtml = `${loaderHtml}<iframe src="${url}" style="width:100%; height:100%; border:none; display:none;" onload="this.style.display='block'; document.getElementById('previewLoader').style.display='none';" title="${title}"></iframe>`;
            } else if (isImg) {
                contentHtml = `${loaderHtml}<div style="display:flex; justify-content:center; align-items:center; width:100%; height:100%;">
                    <img src="${url}" style="max-width:100%; max-height:100%; object-fit:contain; display:none;" onload="this.style.display='block'; document.getElementById('previewLoader').style.display='none';">
                </div>`;
            } else {
                contentHtml = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center;">
                        <i class="fas fa-file-download" style="font-size:4rem; margin-bottom:20px;"></i>
                        <p>Preview not available for this file type.</p>
                        <a href="${url}" target="_blank" download class="preview-modal-btn" style="background:#000; color:#fff; padding:10px 20px; text-decoration:none; border: 2px solid #000; border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; font-family: 'Patrick Hand';">Download File</a>
                    </div>
                `;
            }

            const modalHtml = `
                <style>
                    .preview-modal-btn { transition: all 0.2s !important; cursor: pointer !important; }
                    .preview-modal-btn:hover { 
                        transform: rotate(-3deg) scale(1.1) !important; 
                        animation: previewWiggle 0.4s ease-in-out infinite !important;
                    }
                    @keyframes previewWiggle {
                        0% { transform: rotate(0deg); }
                        25% { transform: rotate(-3deg); }
                        50% { transform: rotate(3deg); }
                        75% { transform: rotate(-1deg); }
                        100% { transform: rotate(0deg); }
                    }
                </style>
                <div id="filePreviewModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; display:flex; justify-content:center; align-items:center;">
                    <div class="sketch-box" style="width:90%; max-width:900px; height:85%; display:flex; flex-direction:column; padding:15px; background:#fff; position:relative; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px dashed #000; padding-bottom:10px; margin-bottom:10px;">
                            <h3 style="margin:0; font-size:1.5rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60%;"><i class="fas fa-eye"></i> ${title}</h3>
                            <div style="display:flex; gap:5px;">
                                <a href="${url}" target="_blank" download style="text-decoration:none;">
                                    <button class="preview-modal-btn" style="width:auto; margin:0; padding:5px 15px; font-size:1rem; background:#0984e3; color:#fff; border: 2px solid #000; border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; font-family: 'Patrick Hand';" title="Download"><i class="fas fa-download"></i></button>
                                </a>
                                <button class="preview-modal-btn" onclick="document.getElementById('filePreviewModal').remove()" style="width:auto; margin:0; padding:5px 15px; font-size:1rem; background:#d63031; color:#fff; border: 2px solid #000; border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; font-family: 'Patrick Hand';">CLOSE</button>
                            </div>
                        </div>
                    <div style="flex:1; overflow:hidden; background:#fff; border:none; position:relative;">${contentHtml}</div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // --- 2. FETCH & RENDER FILES ---
        window.refreshFiles = async function() {
            const list = document.getElementById('file-list');
            if(!list) return;
            
            const { data, error } = await sb.from('shared_files').select('*').neq('subject', 'LandingGallery').order('created_at', { ascending: false });
            if(error) return console.error(error);
            
            globalFiles = data || [];
            renderFileList(globalFiles);
        }

        window.renderFileList = function(files) {
            const list = document.getElementById('file-list');
            if(!files.length) { list.innerHTML = '<p>No files found.</p>'; return; }
            
            // Check Admin
            const currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');
            const isAdmin = currentUser && currentUser.sr_code === 'ADMIN';

            list.innerHTML = files.map(file => {
                const safeUrl = (file.file_url || '').replace(/\\/g, "\\\\").replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const safeTitle = (file.title || 'File').replace(/\\/g, "\\\\").replace(/'/g, "\\'").replace(/"/g, "&quot;");
                const subject = file.subject || 'General';
                const deleteBtn = isAdmin ? `<button onclick="event.stopPropagation(); deleteFile(${file.id})" class="sketch-btn danger" style="position:absolute; top:10px; right:10px; padding: 5px 10px; font-size: 0.9rem; z-index: 50; border-radius: 5px;">X</button>` : '';

                return `
                <div style="width: 100%; background: #fff; border: 2px solid #000; border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px; padding: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 3px 3px 0 rgba(0,0,0,0.1); transition: transform 0.2s; cursor: pointer; margin-bottom: 15px; position: relative;" 
                     onclick="openFilePreview('${safeUrl}', '${safeTitle}')"
                     onmouseover="this.style.transform='scale(1.02) rotate(-1deg)'" 
                     onmouseout="this.style.transform='scale(1) rotate(0deg)'">
                    ${deleteBtn}
                    <div style="font-size: 1.5rem; color: #000;"><i class="fas fa-file-alt"></i></div>
                    <div style="text-align: left; flex: 1;">
                        <div style="font-size: 0.8rem; text-transform: uppercase; font-weight: bold; color: #666;">${subject}</div>
                        <div style="font-size: 1.1rem; line-height: 1.1; font-weight: bold;">${safeTitle}</div>
                        <div style="font-size: 0.8rem; color: #2980b9; margin-top: 2px;"><i class="fas fa-eye"></i> Click to Preview</div>
                    </div>
                </div>`;
            }).join('');
        }

        // Override Search/Filter
        window.searchFiles = function() { const q = document.getElementById('file-search').value.toLowerCase(); renderFileList(globalFiles.filter(f => f.title.toLowerCase().includes(q) || f.subject.toLowerCase().includes(q))); }
        window.filterFiles = function(s) { document.getElementById('file-filter-label').innerText = 'Showing: ' + s; renderFileList(s === 'All' ? globalFiles : globalFiles.filter(f => f.subject === s)); }

        // Override deleteFile to use the inline refresh logic
        window.deleteFile = async function(id) {
            if(window.showWimpyConfirm && !await showWimpyConfirm('Delete this file?')) return;
            if(!window.showWimpyConfirm && !confirm('Delete this file?')) return;

            const { error } = await sb.from('shared_files').delete().eq('id', id);
            if (error) {
                if(window.showToast) showToast('Error deleting file.');
                else alert('Error deleting file.');
            } else {
                if(window.showToast) showToast('File removed.');
                refreshFiles();
            }
        }

        // Override loadFiles to maintain consistency with dashboard.js calls
        window.loadFiles = async function(subject) {
            await refreshFiles();
            if(subject && subject !== 'All') filterFiles(subject);
        }

        // Load on start (Delayed slightly to ensure DOM is ready)
        document.addEventListener('DOMContentLoaded', () => setTimeout(refreshFiles, 1000));

        // --- CUSTOM STATUS LOGIC ---
        window.editUserStatus = function() {
            // FIX: Use global user from dashboard.js (Custom Auth)
            const currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');
            
            if (!currentUser) {
                alert("Please log in to change your status.");
                return;
            }
            
            const el = document.getElementById('user-status-text');
            const current = el.innerText;
            
            document.getElementById('statusInput').value = current;
            document.getElementById('statusModal').classList.remove('hidden');
            setTimeout(() => document.getElementById('statusInput').focus(), 100);
        }

        window.saveUserStatus = async function() {
            const newStatus = document.getElementById('statusInput').value.trim();
            const el = document.getElementById('user-status-text');
            const current = el.innerText;
            const modal = document.getElementById('statusModal');
            
            if (!newStatus) return alert("Status cannot be empty!");
            
            modal.classList.add('hidden');

            if (newStatus !== current) {
                el.innerText = newStatus;
                
                const currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');

                // Save to 'user_statuses' table in Supabase
                const { error } = await sb.from('user_statuses').upsert({
                    user_id: currentUser.id,
                    status: newStatus
                });
                
                if (error) {
                    console.error("Status save failed:", error);
                    alert("Save failed: " + (error.message || "Permission denied"));
                    el.innerText = current; // Revert on error
                } else {
                    showToast("Status updated!");
                }
            }
        }
        // Init Status
        async function initUserStatus() {
            const currentUser = window.user || JSON.parse(localStorage.getItem('wimpy_user') || 'null');
            if (currentUser) {
                const { data } = await sb.from('user_statuses').select('status').eq('user_id', currentUser.id).maybeSingle();
                if (data && data.status) {
                    const el = document.getElementById('user-status-text');
                    if (el) el.innerText = data.status;
                }
            }
        }
        
        // Run on load (delayed slightly to ensure dashboard.js loads user)
        document.addEventListener('DOMContentLoaded', () => setTimeout(initUserStatus, 1000));

        // --- WALLPAPER GENERATOR LOGIC ---
        window.openWallpaperModal = function() {
            document.getElementById('wallpaperModal').classList.remove('hidden');
        }
        
        window.toggleCustomBgInput = function(select) {
            const input = document.getElementById('wp-custom-bg');
            if(select.value === 'custom') input.classList.remove('hidden');
            else input.classList.add('hidden');
        }

        window.generateWallpaperFromSelect = function(e) {
            const val = document.getElementById('wp-size-select').value;
            const bgStyle = document.getElementById('wp-bg-select').value;
            const fileInput = document.getElementById('wp-custom-bg');
            
            // Capture button reference immediately because e.currentTarget is null in async callbacks
            const btn = e.currentTarget;

            let w, h;
            if (val === 'auto') {
                w = Math.round(window.screen.width * (window.devicePixelRatio || 1));
                h = Math.round(window.screen.height * (window.devicePixelRatio || 1));
            } else {
                [w, h] = val.split(',').map(Number);
            }
            
            if (bgStyle === 'custom' && fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    // Pass a mock event object with the captured button
                    generateWallpaper(w, h, bgStyle, { currentTarget: btn }, evt.target.result);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                if (bgStyle === 'custom') {
                    alert("Please select an image file first!");
                    return;
                }
                generateWallpaper(w, h, bgStyle, e);
            }
        }

        window.showWallpaperPreview = function(dataUrl, filename) {
            const overlay = document.createElement('div');
            overlay.className = 'wimpy-modal-overlay';
            overlay.id = 'wp-preview-overlay';
            overlay.style.zIndex = '10002'; // Ensure it's on top
            
            const box = document.createElement('div');
            box.className = 'wimpy-modal-box';
            Object.assign(box.style, {
                maxWidth: '90%',
                maxHeight: '90vh',
                width: 'auto',
                padding: '20px',
                display: 'flex',
                flexDirection: 'column'
            });
            
            box.innerHTML = `
                <h2 style="margin-top:0;"><i class="fas fa-eye"></i> Preview</h2>
                <div style="flex: 1; overflow: auto; margin-bottom: 15px; border: 2px solid #000; background: #eee; display: flex; justify-content: center; align-items: center; min-height: 200px;">
                    <img src="${dataUrl}" style="max-width: 100%; max-height: 60vh; object-fit: contain; display: block; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="wp-download-btn" class="sketch-btn" style="background: #000; color: #fff; width: auto; padding: 10px 20px;">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button onclick="document.getElementById('wp-preview-overlay').remove()" class="sketch-btn danger" style="width: auto; padding: 10px 20px;">
                        Close
                    </button>
                </div>
            `;
            
            overlay.appendChild(box);
            document.body.appendChild(overlay);
            
            document.getElementById('wp-download-btn').onclick = function() {
                const link = document.createElement('a');
                link.download = filename;
                link.href = dataUrl;
                link.click();
                
                // Success Toast
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerText = "Wallpaper Saved!";
                document.getElementById('toast-container').appendChild(toast);
                
                document.getElementById('wp-preview-overlay').remove();
            };
        }

        window.generateWallpaper = async function(width, height, bgStyle, e, customBgData = null) {
            const btn = e.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Drawing...';
            btn.disabled = true;

            // 1. Create the Stage (Off-screen container)
            const stage = document.createElement('div');
            document.body.appendChild(stage);

            const isPortrait = height > width;

            // Apply Wimpy Styles to Stage
            let stageStyles = {
                width: width + 'px',
                height: height + 'px',
                position: 'fixed', top: '0', left: '-9999px', zIndex: '-9999',
                fontFamily: '"Patrick Hand", cursive',
                padding: '80px',
                boxSizing: 'border-box',
                display: 'flex', flexDirection: 'column', alignItems: 'center'
            };

            let cardStyles = {};
            let titleColor = '#000';
            let footerColor = '#7f8c8d';

            if (bgStyle === 'paper') {
                stageStyles.backgroundColor = '#fdfbf7';
                stageStyles.backgroundImage = 'repeating-linear-gradient(#fdfbf7 0px, #fdfbf7 29px, #a4b0be 30px)';
                cardStyles = {
                    background: '#fff',
                    border: '3px solid #000',
                    boxShadow: '5px 5px 0 rgba(0,0,0,0.2)'
                };
            } else {
                // Glassmorphism Base
                cardStyles = {
                    background: 'rgba(255, 255, 255, 0.65)',
                    border: '2px solid rgba(255, 255, 255, 0.9)',
                    boxShadow: '0 8px 32px 0 rgba(0, 0, 0, 0.2)',
                    borderRadius: '15px'
                };
                
                if (bgStyle === 'midnight') {
                    stageStyles.background = 'linear-gradient(to bottom, #0f2027, #203a43, #2c5364)';
                    titleColor = '#fff';
                    footerColor = 'rgba(255,255,255,0.7)';
                } else if (bgStyle === 'sunset') {
                    stageStyles.background = 'linear-gradient(to right, #ff7e5f, #feb47b)';
                } else if (bgStyle === 'ocean') {
                    stageStyles.background = 'linear-gradient(to top, #30cfd0 0%, #330867 100%)';
                    titleColor = '#fff';
                    footerColor = 'rgba(255,255,255,0.7)';
                } else if (bgStyle === 'forest') {
                    stageStyles.background = 'linear-gradient(135deg, #134e5e 0%, #71b280 100%)';
                    titleColor = '#fff';
                    footerColor = 'rgba(255,255,255,0.7)';
                } else if (bgStyle === 'custom' && customBgData) {
                    // Background handled via img tag below for better html2canvas stability
                    titleColor = '#fff';
                    footerColor = 'rgba(255,255,255,0.9)';
                }
            }

            Object.assign(stage.style, {
                ...stageStyles
            });

            // Add Custom Background Image if applicable
            if (bgStyle === 'custom' && customBgData) {
                const bgImg = document.createElement('img');
                bgImg.src = customBgData;
                Object.assign(bgImg.style, {
                    position: 'absolute', top: '0', left: '0', width: '100%', height: '100%',
                    objectFit: 'cover', zIndex: '-1'
                });
                stage.appendChild(bgImg);
            }

            // Add Header
            const title = document.createElement('h1');
            title.innerHTML = "MY CLASS SCHEDULE";
            Object.assign(title.style, {
                fontFamily: '"Permanent Marker", cursive',
                fontSize: isPortrait ? '80px' : '100px',
                marginBottom: '50px',
                transform: 'rotate(-2deg)',
                textShadow: (bgStyle === 'custom') ? '2px 2px 4px rgba(0,0,0,0.8)' : '4px 4px 0px rgba(0,0,0,0.1)',
                color: titleColor
            });
            stage.appendChild(title);

            // Clone Schedule Items
            const grid = document.createElement('div');
            Object.assign(grid.style, {
                display: 'grid',
                gridTemplateColumns: isPortrait ? '1fr' : 'repeat(3, 1fr)',
                gap: '40px', width: '100%', alignContent: 'start'
            });

            const cards = document.querySelectorAll('#schedule-list .class-card');
            if(cards.length === 0) {
                grid.innerHTML = '<h2 style="text-align:center; width:100%;">No classes found! Go have fun!</h2>';
            } else {
                cards.forEach(card => {
                    const clone = card.cloneNode(true);
                    // Remove interactive elements (Buttons, Links) for wallpaper
                    clone.querySelectorAll('button, a').forEach(el => el.remove());

                    // Clean up styles for static image
                    clone.style.animation = 'none';
                    clone.style.opacity = '1';
                    
                    // Apply Card Styles (Glass or Paper)
                    Object.assign(clone.style, cardStyles);

                    if (bgStyle === 'paper') {
                        clone.style.transform = `rotate(${Math.random() * 4 - 2}deg)`;
                    } else {
                        clone.style.transform = `rotate(${Math.random() * 2 - 1}deg)`; // Less rotation for glass
                    }

                    // Boost font size for wallpaper resolution
                    clone.querySelectorAll('*').forEach(el => {
                        const style = window.getComputedStyle(el);
                        const fontSize = parseFloat(style.fontSize);
                        if(fontSize) el.style.fontSize = (fontSize * 1.5) + 'px';
                    });
                    grid.appendChild(clone);
                });
            }
            stage.appendChild(grid);

            // Add Footer
            const footer = document.createElement('div');
            footer.innerText = "Generated by Sistema ni JV";
            Object.assign(footer.style, {
                marginTop: 'auto', fontSize: '40px', color: footerColor, fontFamily: '"Permanent Marker", cursive'
            });
            stage.appendChild(footer);

            // Capture
            try {
                const canvas = await html2canvas(stage, { scale: 1, useCORS: true, logging: false });
                const dataUrl = canvas.toDataURL('image/png');
                const filename = `WimpySchedule_${width}x${height}_${Date.now()}.png`;
                
                showWallpaperPreview(dataUrl, filename);
            } catch (err) {
                console.error(err);
                alert("Oops! Could not generate wallpaper.");
            } finally {
                // Delay removal slightly to allow library cleanup to complete
                setTimeout(() => stage.remove(), 2000);
                btn.innerHTML = originalText;
                btn.disabled = false;
                document.getElementById('wallpaperModal').classList.add('hidden');
            }
        }
    </script>
</body>
</html>